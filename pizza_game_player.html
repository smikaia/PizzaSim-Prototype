<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pizza Menu Game Prototype</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f8f8f8; }
    h1, h2 { color: #b33c00; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
    th { background: #ffe5b4; }
    input[type=number] { width: 50px; }
    .button { background: #b33c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    .button:hover { background: #d35400; }
    .button:disabled { background: #ccc; cursor: not-allowed; }
    .feedback { margin: 10px 0; padding: 10px; background: #fff3e0; border-left: 4px solid #b33c00; }
    .results { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    .simulation-controls { margin: 20px 0; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    .day-counter { font-size: 1.2em; font-weight: bold; color: #b33c00; margin-bottom: 10px; }
    .simulation-summary { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    .day-navigation { margin: 10px 0; }
    .day-navigation button { margin-right: 5px; }
    .cash-display {
      display: inline-block;
      padding: 10px 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #ccc;
      margin-left: 20px;
      font-size: 1.2em;
      font-weight: bold;
      color: #b33c00;
    }
    .cash-display.low {
      color: #ff0000;
    }
    .marketing-controls.disabled {
      opacity: 0.6;
      pointer-events: none;
    }
    /* Pizza Visualization Styles */
    .pizza-visual {
      width: 200px;
      height: 200px;
      background: #f4d03f;
      border-radius: 50%;
      position: relative;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border: 8px solid #e67e22;
      overflow: hidden;
    }
    
    .pizza-crust {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f4d03f;
      border-radius: 50%;
    }
    
    .pizza-sauce {
      position: absolute;
      top: 10%;
      left: 10%;
      right: 10%;
      bottom: 10%;
      background: #e74c3c;
      border-radius: 50%;
      opacity: 0.8;
    }
    
    .pizza-cheese {
      position: absolute;
      top: 15%;
      left: 15%;
      right: 15%;
      bottom: 15%;
      background: #f9e79f;
      border-radius: 50%;
      opacity: 0.9;
    }
    
    .pizza-toppings {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .topping {
      position: absolute;
      font-size: 24px;
      transition: all 0.3s ease;
    }
    
    .ingredient-preview {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 0.9em;
      color: #666;
    }
    
    .ingredient-preview span {
      font-size: 1.2em;
    }
    
    /* New Pizza Menu Card Styles */
    .pizza-menu-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .pizza-card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      width: 280px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
      position: relative;
      border: 2px solid #ffe5b4;
    }
    
    .pizza-card:hover {
      transform: translateY(-5px);
    }
    
    .pizza-card .pizza-name {
      font-size: 1.4em;
      font-weight: bold;
      color: #b33c00;
      text-align: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffe5b4;
    }
    
    .pizza-card .pizza-visual {
      width: 180px;
      height: 180px;
      margin: 0 auto 15px;
    }
    
    .pizza-card .pizza-stats {
      background: #fff3e0;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    
    .pizza-card .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 1.1em;
    }
    
    .pizza-card .stat-label {
      color: #666;
    }
    
    .pizza-card .stat-value {
      font-weight: bold;
      color: #b33c00;
    }
    
    .pizza-card .edit-button {
      background: #b33c00;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      width: 100%;
      font-size: 1.1em;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 15px;
    }
    
    .pizza-card .edit-button:hover {
      background: #d35400;
    }
    
    /* Hide the original table but keep it for data management */
    #pizza-table {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Pizza Menu Game Prototype</h1>
  <div style="display: flex; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0;">Ingredients (Unit Cost)</h2>
    <div class="cash-display" id="cash-display">Cash: $100 USD</div>
  </div>
  <table id="ingredients-table">
    <tr>
      <th>Ingredient</th>
      <th>Unit Cost (USD)</th>
    </tr>
    <tr><td>Cheese</td><td><input type="number" id="cost-cheese" value="2" min="1"></td></tr>
    <tr><td>Tomatoes</td><td><input type="number" id="cost-tomatoes" value="1" min="1"></td></tr>
    <tr><td>Veggies</td><td><input type="number" id="cost-veggies" value="2" min="1"></td></tr>
    <tr><td>Pepperoni</td><td><input type="number" id="cost-pepperoni" value="3" min="1"></td></tr>
  </table>

  <h2>Pizza Menu (Edit Recipes & Price)</h2>
  
  <!-- New Pizza Menu UI -->
  <div class="pizza-menu-container" id="pizza-menu-container">
    <!-- Pizza cards will be dynamically inserted here -->
  </div>
  
  <!-- Original table (hidden but kept for data management) -->
  <table id="pizza-table">
    <tr>
      <th>Pizza</th>
      <th>Cheese</th>
      <th>Tomatoes</th>
      <th>Veggies</th>
      <th>Pepperoni</th>
      <th>Price (USD)</th>
      <th>Total Cost (USD)</th>
      <th>Profit (USD)</th>
    </tr>
    <tr>
      <td><span class="pizza-edit-link" data-pizza="1" style="cursor:pointer; color:#b33c00; text-decoration:underline;">Pizza 1</span></td>
      <td><input type="number" id="p1-cheese" value="3" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p1-tomatoes" value="2" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p1-veggies" value="1" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p1-pepperoni" value="4" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p1-price" value="15" min="1" onchange="updatePizzaCosts()"></td>
      <td id="p1-cost">0</td>
      <td id="p1-profit">0</td>
    </tr>
    <tr>
      <td><span class="pizza-edit-link" data-pizza="2" style="cursor:pointer; color:#b33c00; text-decoration:underline;">Pizza 2</span></td>
      <td><input type="number" id="p2-cheese" value="0" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p2-tomatoes" value="1" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p2-veggies" value="4" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p2-pepperoni" value="2" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p2-price" value="13" min="1" onchange="updatePizzaCosts()"></td>
      <td id="p2-cost">0</td>
      <td id="p2-profit">0</td>
    </tr>
    <tr>
      <td><span class="pizza-edit-link" data-pizza="3" style="cursor:pointer; color:#b33c00; text-decoration:underline;">Pizza 3</span></td>
      <td><input type="number" id="p3-cheese" value="2" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p3-tomatoes" value="3" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p3-veggies" value="2" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p3-pepperoni" value="1" min="0" onchange="updatePizzaCosts()"></td>
      <td><input type="number" id="p3-price" value="12" min="1" onchange="updatePizzaCosts()"></td>
      <td id="p3-cost">0</td>
      <td id="p3-profit">0</td>
    </tr>
  </table>

  <div class="simulation-controls">
    <div class="day-counter">Day: <span id="current-day">1</span> of 5</div>
    
    <div class="marketing-controls" style="margin: 15px 0; padding: 15px; background: #fff3e0; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #b33c00;">Marketing Activity (Optional)</h3>
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px;">Activity Type:</label>
        <select id="marketing-type" style="padding: 5px; margin-right: 10px;">
          <option value="none">No Marketing</option>
          <option value="flyer">Flyer Drop ($5)</option>
          <option value="social">Social Media Ads ($15)</option>
          <option value="mascot">Street Mascot ($30)</option>
        </select>
        
        <select id="marketing-target" style="padding: 5px;" disabled>
          <option value="">Select Target Segment</option>
          <option value="Student">Students</option>
          <option value="Tourist">Tourists</option>
          <option value="Healthy Eater">Healthy Eaters</option>
          <option value="Gourmet Eater">Gourmet Eaters</option>
        </select>
      </div>
      <div id="marketing-cost" style="font-weight: bold; color: #b33c00;"></div>
    </div>

    <button class="button" id="simulate-button" onclick="simulateDay()">Simulate Day</button>
    <button class="button" id="next-day-button" onclick="nextDay()" disabled>Next Day</button>
    <button class="button" id="reset-button" onclick="resetSimulation()">Reset Simulation</button>
  </div>

  <div class="results" id="results" style="display:none;">
    <div class="day-navigation" id="day-navigation" style="display:none;">
      <button class="button" onclick="showPreviousDay()">Previous Day</button>
      <button class="button" onclick="showNextDay()">Next Day</button>
    </div>
    <div id="current-day-results"></div>
  </div>

  <div class="simulation-summary" id="simulation-summary" style="display:none;">
    <h2>Simulation Summary</h2>
    <div id="summary-content"></div>
  </div>

  <!-- Minami Lane-style Pizza Edit Modal -->
  <div id="pizza-edit-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
    <div id="pizza-edit-content" style="background:#fffbe9; border-radius:18px; box-shadow:0 4px 24px #bfae8e; padding:32px 40px; min-width:380px; max-width:95vw; position:relative;">
      <button id="pizza-edit-close" style="position:absolute; top:18px; right:18px; background:none; border:none; font-size:1.5em; cursor:pointer; color:#b33c00;">&times;</button>
      <div style="display:flex; align-items:center; gap:18px; margin-bottom:18px;">
        <div id="pizza-edit-icon" style="width:64px; height:64px; background:#ffe5b4; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2.5em;">🍕</div>
        <div>
          <input id="pizza-edit-title" type="text" style="font-size:1.2em; font-weight:bold; color:#b33c00; background: #fffbe9; border: 1px solid #bfae8e; border-radius: 6px; padding: 4px 10px; width: 160px;" maxlength="32" />
        </div>
      </div>
      
      <!-- Add Pizza Visualization -->
      <div class="pizza-visual">
        <div class="pizza-crust"></div>
        <div class="pizza-sauce"></div>
        <div class="pizza-cheese"></div>
        <div class="pizza-toppings" id="pizza-toppings"></div>
      </div>
      
      <div style="margin-bottom:18px;">
        <div style="font-weight:bold; margin-bottom:8px;">Customize your pizza</div>
        <div id="pizza-edit-ingredients"></div>
      </div>
      <div style="margin-bottom:18px; display:flex; gap:24px; align-items:center;">
        <div>Total cost: <span id="pizza-edit-total-cost" style="font-weight:bold; color:#b33c00;"></span></div>
        <div>Profit: <span id="pizza-edit-profit" style="font-weight:bold; color:#b33c00;"></span></div>
      </div>
      <div style="margin-bottom:18px;">
        <label for="pizza-edit-price" style="font-weight:bold;">Selling price: $</label>
        <input type="number" id="pizza-edit-price" min="1" style="width:70px; padding:4px 8px; border-radius:6px; border:1px solid #ccc; font-size:1em;">
      </div>
      <button id="pizza-edit-done" class="button" style="width:100%; font-size:1.1em;">Done</button>
    </div>
  </div>

  <script>
    // Ingredient names
    const INGREDIENTS = ["cheese", "tomatoes", "veggies", "pepperoni"];

    // Customer segments
    const CUSTOMER_SEGMENTS = [
      {
        name: "Student",
        taste: { cheese: 2, tomatoes: 2, veggies: 1, pepperoni: 4 },
        priceMin: 12, priceMax: 15,
        totalCustomers: 40
      },
      {
        name: "Tourist",
        taste: { cheese: 3, tomatoes: 3, veggies: 2, pepperoni: 2 },
        priceMin: 14, priceMax: 18,
        totalCustomers: 30
      },
      {
        name: "Healthy Eater",
        taste: { cheese: 1, tomatoes: 3, veggies: 4, pepperoni: 0 },
        priceMin: 13, priceMax: 16,
        totalCustomers: 15
      },
      {
        name: "Gourmet Eater",
        taste: { cheese: 4, tomatoes: 2, veggies: 2, pepperoni: 3 },
        priceMin: 16, priceMax: 20,
        totalCustomers: 15
      }
    ];

    // Track which customers have visited
    let visitedCustomers = {
      "Student": new Set(),
      "Tourist": new Set(),
      "Healthy Eater": new Set(),
      "Gourmet Eater": new Set()
    };

    // Feedback templates
    const FEEDBACK = {
      cheese: [
        "could use more cheese!",
        "has too much cheese for my taste.",
        "perfect amount of cheese!"
      ],
      tomatoes: [
        "needs more tomatoes!",
        "has too many tomatoes.",
        "tomatoes are just right!"
      ],
      veggies: [
        "I wish there were more veggies.",
        "too many veggies for me.",
        "veggies are perfect!"
      ],
      pepperoni: [
        "more pepperoni would be great!",
        "too much pepperoni!",
        "pepperoni is spot on!"
      ],
      price: [
        "Price is too high for me.",
        "Great value for the price!",
        "Could be a bit cheaper."
      ]
    };

    // Track pizza names (default to Pizza 1, 2, 3)
    let pizzaNames = ["Pizza 1", "Pizza 2", "Pizza 3"];

    function getPizzaData() {
      // Get pizza recipes and prices from inputs
      let pizzas = [];
      for (let i = 1; i <= 3; i++) {
        let recipe = {};
        INGREDIENTS.forEach(ing => {
          recipe[ing] = parseInt(document.getElementById(`p${i}-${ing}`).value, 10);
        });
        let price = parseInt(document.getElementById(`p${i}-price`).value, 10);
        // Use pizzaNames array for the name
        let name = pizzaNames[i-1] || `Pizza ${i}`;
        pizzas.push({ name, recipe, price });
      }
      return pizzas;
    }

    function getIngredientCosts() {
      return {
        cheese: parseInt(document.getElementById('cost-cheese').value, 10),
        tomatoes: parseInt(document.getElementById('cost-tomatoes').value, 10),
        veggies: parseInt(document.getElementById('cost-veggies').value, 10),
        pepperoni: parseInt(document.getElementById('cost-pepperoni').value, 10)
      };
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Simulation state
    let currentDay = 1;
    let simulationComplete = false;
    let dayResults = [];
    let currentDayView = 1;

    // Marketing activity effects
    const MARKETING_EFFECTS = {
      flyer: 1.5,    // 50% increase in probability
      social: 2.0,   // 100% increase in probability
      mascot: 3.0    // 200% increase in probability
    };

    const MARKETING_COSTS = {
      flyer: 5,
      social: 15,
      mascot: 30
    };

    // Add cash management
    let playerCash = 100; // Starting cash

    function updateCashDisplay() {
      const cashDisplay = document.getElementById('cash-display');
      cashDisplay.textContent = `Cash: $${playerCash} USD`;
      cashDisplay.classList.toggle('low', playerCash < 30); // Red if less than cheapest marketing
    }

    function updateMarketingControls() {
      const marketingType = document.getElementById('marketing-type');
      const marketingControls = document.querySelector('.marketing-controls');
      const simulateButton = document.getElementById('simulate-button');
      
      // Disable marketing controls if not enough cash
      if (playerCash < 5) {
        marketingControls.classList.add('disabled');
        if (marketingType.value !== 'none') {
          marketingType.value = 'none';
          document.getElementById('marketing-target').value = '';
          document.getElementById('marketing-target').disabled = true;
          document.getElementById('marketing-cost').textContent = '';
        }
      } else {
        marketingControls.classList.remove('disabled');
      }

      // Update available marketing options based on cash
      Array.from(marketingType.options).forEach(option => {
        if (option.value !== 'none') {
          const cost = MARKETING_COSTS[option.value];
          option.disabled = playerCash < cost;
        }
      });
    }

    // Update marketing type change handler
    document.getElementById('marketing-type').addEventListener('change', function() {
      const targetSelect = document.getElementById('marketing-target');
      const costDisplay = document.getElementById('marketing-cost');
      
      if (this.value === 'none') {
        targetSelect.disabled = true;
        targetSelect.value = '';
        costDisplay.textContent = '';
      } else {
        const cost = MARKETING_COSTS[this.value];
        if (playerCash >= cost) {
          targetSelect.disabled = false;
          costDisplay.textContent = `Cost: $${cost} USD`;
        } else {
          this.value = 'none';
          targetSelect.disabled = true;
          targetSelect.value = '';
          costDisplay.textContent = '';
        }
      }
    });

    function simulateDay() {
      if (currentDay > 5 || simulationComplete) return;
      
      const pizzas = getPizzaData();
      const ingredientCosts = getIngredientCosts();
      let customers = [];
      
      // Get marketing selection and verify cash
      const marketingType = document.getElementById('marketing-type').value;
      const marketingTarget = document.getElementById('marketing-target').value;
      let marketingCost = 0;
      let marketingEffect = 1;
      
      if (marketingType !== 'none' && marketingTarget) {
        marketingCost = MARKETING_COSTS[marketingType];
        if (playerCash < marketingCost) {
          alert('Not enough cash for selected marketing activity!');
          return;
        }
        marketingEffect = MARKETING_EFFECTS[marketingType];
      }
      
      // Select customers with marketing effects
      let availableCustomers = [];
      CUSTOMER_SEGMENTS.forEach(segment => {
        for (let i = 1; i <= segment.totalCustomers; i++) {
          if (!visitedCustomers[segment.name].has(i)) {
            // Apply marketing effect to target segment
            let weight = segment.name === marketingTarget ? marketingEffect : 1;
            availableCustomers.push({ segment, customerId: i, weight });
          }
        }
      });

      // If we have less than 10 available customers, reset the visited customers
      if (availableCustomers.length < 10) {
        CUSTOMER_SEGMENTS.forEach(segment => {
          visitedCustomers[segment.name].clear();
        });
        availableCustomers = [];
        CUSTOMER_SEGMENTS.forEach(segment => {
          for (let i = 1; i <= segment.totalCustomers; i++) {
            let weight = segment.name === marketingTarget ? marketingEffect : 1;
            availableCustomers.push({ segment, customerId: i, weight });
          }
        });
      }

      // Weighted random selection of customers
      let totalWeight = availableCustomers.reduce((sum, c) => sum + c.weight, 0);
      for (let i = 0; i < 10; i++) {
        if (availableCustomers.length === 0) break;
        
        // Weighted random selection
        let random = Math.random() * totalWeight;
        let selectedIndex = 0;
        let weightSum = 0;
        
        for (let j = 0; j < availableCustomers.length; j++) {
          weightSum += availableCustomers[j].weight;
          if (random <= weightSum) {
            selectedIndex = j;
            break;
          }
        }
        
        const selected = availableCustomers.splice(selectedIndex, 1)[0];
        customers.push({ 
          id: selected.customerId, 
          segment: selected.segment,
          segmentName: selected.segment.name 
        });
        visitedCustomers[selected.segment.name].add(selected.customerId);
        
        // Update total weight
        totalWeight -= selected.weight;
      }

      let dayResult = {
        day: currentDay,
        customers: [],
        totalSatisfaction: 0,
        dailyProfit: 0,
        segmentSatisfaction: {},
        segmentCounts: {},
        segmentTotalServed: {},
        marketing: marketingType !== 'none' ? {
          type: marketingType,
          target: marketingTarget,
          cost: marketingCost
        } : null
      };

      // Initialize segment tracking
      CUSTOMER_SEGMENTS.forEach(seg => {
        dayResult.segmentSatisfaction[seg.name] = 0;
        dayResult.segmentCounts[seg.name] = 0;
        // Calculate total customers served so far for each segment
        dayResult.segmentTotalServed[seg.name] = visitedCustomers[seg.name].size;
      });

      let resultsHTML = `<h2>Day ${currentDay} Results</h2>`;
      resultsHTML += `<table><tr><th>Customer</th><th>Segment</th><th>Pizza Chosen</th><th>Feedback</th><th>Satisfaction</th></tr>`;

      customers.forEach((customer, idx) => {
        // Find best pizza for this customer
        let bestPizza = null;
        let bestScore = -Infinity;
        let bestDiff = null;
        pizzas.forEach(pizza => {
          // Calculate taste match (lower is better)
          let tasteDiff = 0;
          INGREDIENTS.forEach(ing => {
            tasteDiff += Math.abs(pizza.recipe[ing] - customer.segment.taste[ing]);
          });
          // Calculate price match (0 if in range, else penalty)
          let pricePenalty = 0;
          if (pizza.price < customer.segment.priceMin) pricePenalty = customer.segment.priceMin - pizza.price;
          else if (pizza.price > customer.segment.priceMax) pricePenalty = pizza.price - customer.segment.priceMax;
          // Lower total diff is better
          let totalDiff = tasteDiff + pricePenalty;
          // For tie-breaking, prefer lower price
          let score = -totalDiff - pizza.price * 0.01;
          if (score > bestScore) {
            bestScore = score;
            bestPizza = pizza;
            bestDiff = { tasteDiff, pricePenalty, pizza };
          }
        });
        // Feedback: find biggest difference
        let maxIng = null, maxDiff = 0;
        INGREDIENTS.forEach(ing => {
          let diff = Math.abs(bestPizza.recipe[ing] - customer.segment.taste[ing]);
          if (diff > maxDiff) { maxDiff = diff; maxIng = ing; }
        });
        let priceDiff = 0;
        if (bestPizza.price < customer.segment.priceMin) priceDiff = customer.segment.priceMin - bestPizza.price;
        else if (bestPizza.price > customer.segment.priceMax) priceDiff = bestPizza.price - customer.segment.priceMax;
        // Decide if price or ingredient is most critical
        let feedback = "";
        // If perfect match, give special feedback
        if (bestDiff.tasteDiff === 0 && bestDiff.pricePenalty === 0) {
          feedback = `This pizza (${bestPizza.name}) is perfect for me!`;
        } else if (priceDiff > maxDiff) {
          if (bestPizza.price > customer.segment.priceMax) {
            feedback = FEEDBACK.price[0]; // "Price is too high for me."
          } else if (bestPizza.price < customer.segment.priceMin) {
            feedback = "This pizza is too cheap for me.";
          } else {
            feedback = FEEDBACK.price[2]; // "Could be a bit cheaper."
          }
        } else if (maxDiff > 0) {
          let ing = maxIng;
          if (bestPizza.recipe[ing] > customer.segment.taste[ing]) feedback = FEEDBACK[ing][1];
          else feedback = FEEDBACK[ing][0];
        } else {
          feedback = FEEDBACK[INGREDIENTS[randomInt(0,3)]][2];
        }
        // Satisfaction: base 10, minus taste and price penalties
        let satisfaction = 10 - bestDiff.tasteDiff - bestDiff.pricePenalty;
        if (satisfaction < 1) satisfaction = 1;
        if (satisfaction > 10) satisfaction = 10;
        dayResult.totalSatisfaction += satisfaction;
        dayResult.segmentSatisfaction[customer.segmentName] += satisfaction;
        dayResult.segmentCounts[customer.segmentName] += 1;
        // Calculate profit for this pizza sale
        let pizzaCost = 0;
        INGREDIENTS.forEach(ing => {
          pizzaCost += bestPizza.recipe[ing] * ingredientCosts[ing];
        });
        let pizzaProfit = bestPizza.price - pizzaCost;
        dayResult.dailyProfit += pizzaProfit;
        // Store customer result
        dayResult.customers.push({
          id: customer.id,
          segment: customer.segmentName,
          pizza: bestPizza.name,
          pizzaIndex: pizzas.indexOf(bestPizza), // store index for robustness
          feedback: feedback,
          satisfaction: satisfaction
        });
        resultsHTML += `<tr><td>C${customer.id}</td><td>${customer.segmentName}</td><td>${bestPizza.name}</td><td>${feedback}</td><td>${satisfaction}</td></tr>`;
      });

      resultsHTML += `</table>`;
      resultsHTML += `<p><b>Average Satisfaction:</b> ${(dayResult.totalSatisfaction/10).toFixed(2)} / 10</p>`;
      resultsHTML += `<p><b>Daily Profit:</b> $${dayResult.dailyProfit} USD</p>`;
      
      resultsHTML += `<h3>Average Satisfaction by Segment</h3><ul>`;
      CUSTOMER_SEGMENTS.forEach(seg => {
        let avgSatisfaction = dayResult.segmentCounts[seg.name] > 0 ? 
          (dayResult.segmentSatisfaction[seg.name] / dayResult.segmentCounts[seg.name]) : 0;
        
        // Calculate segment coverage (percentage of total segment served)
        let coverage = (dayResult.segmentTotalServed[seg.name] / seg.totalCustomers) * 100;
        
        // Calculate weighted satisfaction (satisfaction * coverage)
        let weightedSatisfaction = avgSatisfaction * (coverage / 100);
        
        resultsHTML += `<li><b>${seg.name}:</b> ${avgSatisfaction.toFixed(2)} / 10 (${coverage.toFixed(1)}% of segment served, weighted: ${weightedSatisfaction.toFixed(2)})</li>`;
      });
      resultsHTML += `</ul>`;

      // Update cash and profit
      dayResult.dailyProfit -= marketingCost;
      playerCash += dayResult.dailyProfit;
      updateCashDisplay();
      updateMarketingControls();

      // Update results display to show cash
      if (marketingType !== 'none') {
        resultsHTML = `<div class="feedback" style="margin-bottom: 15px;">
          <b>Marketing Activity:</b> ${marketingType.charAt(0).toUpperCase() + marketingType.slice(1)} 
          targeting ${marketingTarget} (Cost: $${marketingCost})<br>
          <b>Remaining Cash:</b> $${playerCash} USD
        </div>` + resultsHTML;
      } else {
        resultsHTML = `<div class="feedback" style="margin-bottom: 15px;">
          <b>Remaining Cash:</b> $${playerCash} USD
        </div>` + resultsHTML;
      }

      // Store the day's results
      dayResults[currentDay - 1] = dayResult;
      document.getElementById('current-day-results').innerHTML = resultsHTML;
      document.getElementById('results').style.display = 'block';
      document.getElementById('day-navigation').style.display = 'block';
      
      // Update simulation state
      document.getElementById('simulate-button').disabled = true;
      document.getElementById('next-day-button').disabled = false;
      
      if (currentDay === 5) {
        simulationComplete = true;
        document.getElementById('next-day-button').disabled = true;
        updateSimulationSummary();
      }
    }

    function nextDay() {
      if (currentDay < 5 && !simulationComplete) {
        currentDay++;
        currentDayView = currentDay;
        document.getElementById('current-day').textContent = currentDay;
        document.getElementById('simulate-button').disabled = false;
        document.getElementById('next-day-button').disabled = true;
        document.getElementById('results').style.display = 'none';
        document.getElementById('marketing-type').value = 'none';
        document.getElementById('marketing-target').value = '';
        document.getElementById('marketing-target').disabled = true;
        document.getElementById('marketing-cost').textContent = '';
        updateMarketingControls();
      }
    }

    function resetSimulation() {
      currentDay = 1;
      currentDayView = 1;
      simulationComplete = false;
      dayResults = [];
      // Reset visited customers tracking
      CUSTOMER_SEGMENTS.forEach(segment => {
        visitedCustomers[segment.name].clear();
      });
      document.getElementById('current-day').textContent = currentDay;
      document.getElementById('simulate-button').disabled = false;
      document.getElementById('next-day-button').disabled = true;
      document.getElementById('results').style.display = 'none';
      document.getElementById('simulation-summary').style.display = 'none';
      document.getElementById('marketing-type').value = 'none';
      document.getElementById('marketing-target').value = '';
      document.getElementById('marketing-target').disabled = true;
      document.getElementById('marketing-cost').textContent = '';
      playerCash = 100;
      updateCashDisplay();
      updateMarketingControls();
    }

    function showPreviousDay() {
      if (currentDayView > 1) {
        currentDayView--;
        displayDayResults(currentDayView);
      }
    }

    function showNextDay() {
      if (currentDayView < currentDay) {
        currentDayView++;
        displayDayResults(currentDayView);
      }
    }

    function displayDayResults(day) {
      if (dayResults[day - 1]) {
        const result = dayResults[day - 1];
        let resultsHTML = `<h2>Day ${day} Results</h2>`;
        resultsHTML += `<table><tr><th>Customer</th><th>Segment</th><th>Pizza Chosen</th><th>Feedback</th><th>Satisfaction</th></tr>`;
        
        result.customers.forEach(customer => {
          // Use the pizzaNames array for the current name
          let pizzaName = pizzaNames[customer.pizzaIndex] || customer.pizza;
          resultsHTML += `<tr><td>C${customer.id}</td><td>${customer.segment}</td><td>${pizzaName}</td><td>${customer.feedback}</td><td>${customer.satisfaction}</td></tr>`;
        });
        
        resultsHTML += `</table>`;
        resultsHTML += `<p><b>Average Satisfaction:</b> ${(result.totalSatisfaction/10).toFixed(2)} / 10</p>`;
        resultsHTML += `<p><b>Daily Profit:</b> $${result.dailyProfit} USD</p>`;
        
        resultsHTML += `<h3>Average Satisfaction by Segment</h3><ul>`;
        CUSTOMER_SEGMENTS.forEach(seg => {
          let avg = result.segmentCounts[seg.name] > 0 ? 
            (result.segmentSatisfaction[seg.name] / result.segmentCounts[seg.name]).toFixed(2) : 'N/A';
          resultsHTML += `<li><b>${seg.name}:</b> ${avg} / 10</li>`;
        });
        resultsHTML += `</ul>`;
        
        document.getElementById('current-day-results').innerHTML = resultsHTML;
        document.getElementById('results').style.display = 'block';
      }
    }

    function updateSimulationSummary() {
      if (dayResults.length === 0) return;
      
      let totalProfit = 0;
      let totalSatisfaction = 0;
      let bestPizzaByDay = [];
      let segmentTrends = {};
      let segmentCoverage = {};
      
      CUSTOMER_SEGMENTS.forEach(seg => {
        segmentTrends[seg.name] = [];
        segmentCoverage[seg.name] = [];
      });
      
      dayResults.forEach((day, index) => {
        totalProfit += day.dailyProfit;
        totalSatisfaction += day.totalSatisfaction;
        
        // Find best performing pizza for the day
        let pizzaSales = {};
        day.customers.forEach(customer => {
          pizzaSales[customer.pizza] = (pizzaSales[customer.pizza] || 0) + 1;
        });
        let bestPizza = Object.entries(pizzaSales).sort((a, b) => b[1] - a[1])[0][0];
        bestPizzaByDay.push({ day: index + 1, pizza: bestPizza });
        
        // Track segment satisfaction and coverage trends
        CUSTOMER_SEGMENTS.forEach(seg => {
          let avg = day.segmentCounts[seg.name] > 0 ? 
            (day.segmentSatisfaction[seg.name] / day.segmentCounts[seg.name]) : 0;
          let coverage = (day.segmentTotalServed[seg.name] / seg.totalCustomers) * 100;
          segmentTrends[seg.name].push(avg);
          segmentCoverage[seg.name].push(coverage);
        });
      });
      
      let summaryHTML = `
        <p><b>Total Profit:</b> $${totalProfit} USD</p>
        <p><b>Average Satisfaction:</b> ${(totalSatisfaction/(dayResults.length * 10)).toFixed(2)} / 10</p>
        
        <h3>Best Performing Pizza by Day</h3>
        <ul>
          ${bestPizzaByDay.map(day => `<li>Day ${day.day}: ${day.pizza}</li>`).join('')}
        </ul>
        
        <h3>Customer Segment Analysis</h3>
        <ul>
          ${CUSTOMER_SEGMENTS.map(seg => `
            <li><b>${seg.name}:</b><br>
                Satisfaction: ${segmentTrends[seg.name].map(s => s.toFixed(2)).join(' → ')}<br>
                Coverage: ${segmentCoverage[seg.name].map(c => c.toFixed(1) + '%').join(' → ')}<br>
                Final Weighted Score: ${(segmentTrends[seg.name][segmentTrends[seg.name].length-1] * 
                (segmentCoverage[seg.name][segmentCoverage[seg.name].length-1]/100)).toFixed(2)} / 10
            </li>
          `).join('')}
        </ul>
      `;
      
      document.getElementById('summary-content').innerHTML = summaryHTML;
      document.getElementById('simulation-summary').style.display = 'block';
    }

    // Update pizza costs and profits
    function updatePizzaCosts() {
      const ingredientCosts = getIngredientCosts();
      for (let i = 1; i <= 3; i++) {
        let totalCost = 0;
        INGREDIENTS.forEach(ing => {
          const qty = parseInt(document.getElementById(`p${i}-${ing}`).value, 10);
          totalCost += qty * ingredientCosts[ing];
        });
        const price = parseInt(document.getElementById(`p${i}-price`).value, 10);
        const profit = price - totalCost;
        document.getElementById(`p${i}-cost`).textContent = totalCost;
        document.getElementById(`p${i}-profit`).textContent = profit;
      }
    }
    // Update costs when ingredient unit costs change
    document.getElementById('cost-cheese').addEventListener('change', updatePizzaCosts);
    document.getElementById('cost-tomatoes').addEventListener('change', updatePizzaCosts);
    document.getElementById('cost-veggies').addEventListener('change', updatePizzaCosts);
    document.getElementById('cost-pepperoni').addEventListener('change', updatePizzaCosts);
    // Initial update
    updatePizzaCosts();

    // Initial setup
    updateCashDisplay();
    updateMarketingControls();

    // --- Pizza Edit Modal Logic ---
    const PIZZA_ICONS = ['🍕','🍕','🍕']; // You can use different icons if you want
    // Add ingredient emojis mapping
    const INGREDIENT_EMOJIS = {
      cheese: '🧀',
      tomatoes: '🍅',
      veggies: '🥬',
      pepperoni: '🍖'
    };
    
    // Add ingredient colors for visual feedback
    const INGREDIENT_COLORS = {
      cheese: '#f9e79f',
      tomatoes: '#e74c3c',
      veggies: '#2ecc71',
      pepperoni: '#c0392b'
    };
    
    function updatePizzaVisual(ingredients) {
      const toppingsContainer = document.getElementById('pizza-toppings');
      toppingsContainer.innerHTML = '';
      
      // Calculate total ingredients for scaling
      const totalIngredients = Object.values(ingredients).reduce((sum, qty) => sum + qty, 0);
      
      // Add toppings based on quantities
      Object.entries(ingredients).forEach(([ing, qty]) => {
        for (let i = 0; i < qty; i++) {
          const topping = document.createElement('div');
          topping.className = 'topping';
          topping.textContent = INGREDIENT_EMOJIS[ing];
          
          // Position toppings in a spiral pattern
          const angle = (i / qty) * Math.PI * 2;
          const radius = 70 * (1 - (totalIngredients - qty) / (totalIngredients * 2));
          const x = Math.cos(angle) * radius;
          const y = Math.sin(angle) * radius;
          
          topping.style.transform = `translate(${x}px, ${y}px)`;
          toppingsContainer.appendChild(topping);
        }
      });
    }
    
    function openPizzaEditModal(pizzaIndex) {
      const pizzas = getPizzaData();
      const ingredientCosts = getIngredientCosts();
      const pizza = pizzas[pizzaIndex];
      document.getElementById('pizza-edit-title').value = pizzaNames[pizzaIndex];
      document.getElementById('pizza-edit-icon').textContent = PIZZA_ICONS[pizzaIndex];
      
      // Build ingredient controls
      const ingDiv = document.getElementById('pizza-edit-ingredients');
      ingDiv.innerHTML = '';
      
      // Initial pizza visualization
      updatePizzaVisual(pizza.recipe);
      
      INGREDIENTS.forEach(ing => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.marginBottom = '8px';
        row.innerHTML = `
          <span style="width:90px; display:inline-block; font-weight:bold; color:#b33c00;">
            ${INGREDIENT_EMOJIS[ing]} ${ing.charAt(0).toUpperCase()+ing.slice(1)}
          </span>
          <button class="pizza-edit-minus" data-ing="${ing}" style="background:#ffe5b4; border:none; border-radius:50%; width:32px; height:32px; font-size:1.3em; color:#b33c00; margin:0 8px;">-</button>
          <span class="pizza-edit-qty" data-ing="${ing}" style="min-width:24px; display:inline-block; text-align:center; font-size:1.1em;">${pizza.recipe[ing]}</span>
          <button class="pizza-edit-plus" data-ing="${ing}" style="background:#ffe5b4; border:none; border-radius:50%; width:32px; height:32px; font-size:1.3em; color:#b33c00; margin:0 8px;">+</button>
          <span style="margin-left:8px; color:#888;">$${ingredientCosts[ing]}</span>
        `;
        ingDiv.appendChild(row);
      });
      
      // Set price
      document.getElementById('pizza-edit-price').value = pizza.price;
      // Update cost/profit
      function updateModalCostProfit() {
        let totalCost = 0;
        INGREDIENTS.forEach(ing => {
          const qty = parseInt(document.querySelector(`.pizza-edit-qty[data-ing='${ing}']`).textContent, 10);
          totalCost += qty * ingredientCosts[ing];
        });
        const price = parseInt(document.getElementById('pizza-edit-price').value, 10);
        document.getElementById('pizza-edit-total-cost').textContent = `$${totalCost}`;
        document.getElementById('pizza-edit-profit').textContent = `$${price - totalCost}`;
      }
      updateModalCostProfit();
      // + and - button handlers
      ingDiv.querySelectorAll('.pizza-edit-minus').forEach(btn => {
        btn.onclick = function() {
          const ing = btn.getAttribute('data-ing');
          const qtySpan = ingDiv.querySelector(`.pizza-edit-qty[data-ing='${ing}']`);
          let qty = parseInt(qtySpan.textContent, 10);
          if (qty > 0) qty--;
          qtySpan.textContent = qty;
          
          // Update visual pizza
          const currentIngredients = {};
          INGREDIENTS.forEach(i => {
            currentIngredients[i] = parseInt(ingDiv.querySelector(`.pizza-edit-qty[data-ing='${i}']`).textContent, 10);
          });
          updatePizzaVisual(currentIngredients);
          
          updateModalCostProfit();
        };
      });
      ingDiv.querySelectorAll('.pizza-edit-plus').forEach(btn => {
        btn.onclick = function() {
          const ing = btn.getAttribute('data-ing');
          const qtySpan = ingDiv.querySelector(`.pizza-edit-qty[data-ing='${ing}']`);
          let qty = parseInt(qtySpan.textContent, 10);
          qty++;
          qtySpan.textContent = qty;
          
          // Update visual pizza
          const currentIngredients = {};
          INGREDIENTS.forEach(i => {
            currentIngredients[i] = parseInt(ingDiv.querySelector(`.pizza-edit-qty[data-ing='${i}']`).textContent, 10);
          });
          updatePizzaVisual(currentIngredients);
          
          updateModalCostProfit();
        };
      });
      document.getElementById('pizza-edit-price').oninput = updateModalCostProfit;
      // Show modal
      document.getElementById('pizza-edit-modal').style.display = 'flex';
      // Done button handler
      document.getElementById('pizza-edit-done').onclick = function() {
        // Write back to main table
        INGREDIENTS.forEach(ing => {
          const qty = parseInt(ingDiv.querySelector(`.pizza-edit-qty[data-ing='${ing}']`).textContent, 10);
          document.getElementById(`p${pizzaIndex+1}-${ing}`).value = qty;
        });
        document.getElementById(`p${pizzaIndex+1}-price`).value = parseInt(document.getElementById('pizza-edit-price').value, 10);
        // Update pizza name in the main table
        const newName = document.getElementById('pizza-edit-title').value.trim() || `Pizza ${pizzaIndex+1}`;
        // Update the clickable pizza name in the table
        const pizzaLink = document.querySelector(`.pizza-edit-link[data-pizza='${pizzaIndex+1}']`);
        pizzaLink.textContent = newName;
        pizzaLink.setAttribute('data-pizza-name', newName);
        pizzaNames[pizzaIndex] = newName;
        updatePizzaCosts();
        document.getElementById('pizza-edit-modal').style.display = 'none';
      };
    }
    // Close modal handler
    document.getElementById('pizza-edit-close').onclick = function() {
      document.getElementById('pizza-edit-modal').style.display = 'none';
    };
    // Open modal on pizza name click
    document.querySelectorAll('.pizza-edit-link').forEach(link => {
      link.onclick = function() {
        const idx = parseInt(link.getAttribute('data-pizza'), 10) - 1;
        openPizzaEditModal(idx);
        // If a custom name was set, use it
        const customName = link.getAttribute('data-pizza-name');
        if (customName) {
          document.getElementById('pizza-edit-title').value = customName;
        }
      };
    });

    // Add function to update pizza menu cards
    function updatePizzaMenuCards() {
      const container = document.getElementById('pizza-menu-container');
      container.innerHTML = '';
      
      for (let i = 1; i <= 3; i++) {
        const pizzaName = pizzaNames[i-1] || `Pizza ${i}`;
        const totalCost = document.getElementById(`p${i}-cost`).textContent;
        const price = document.getElementById(`p${i}-price`).value;
        const profit = document.getElementById(`p${i}-profit`).textContent;
        
        // Get current recipe
        const recipe = {};
        INGREDIENTS.forEach(ing => {
          recipe[ing] = parseInt(document.getElementById(`p${i}-${ing}`).value, 10);
        });
        
        const card = document.createElement('div');
        card.className = 'pizza-card';
        card.innerHTML = `
          <div class="pizza-name">${pizzaName}</div>
          <div class="pizza-visual">
            <div class="pizza-crust"></div>
            <div class="pizza-sauce"></div>
            <div class="pizza-cheese"></div>
            <div class="pizza-toppings" id="menu-pizza-${i}-toppings"></div>
          </div>
          <div class="pizza-stats">
            <div class="stat-row">
              <span class="stat-label">Total Cost:</span>
              <span class="stat-value">$${totalCost}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Price:</span>
              <span class="stat-value">$${price}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Profit:</span>
              <span class="stat-value">$${profit}</span>
            </div>
          </div>
          <button class="edit-button" onclick="openPizzaEditModal(${i-1})">Edit Pizza</button>
        `;
        
        container.appendChild(card);
        
        // Update pizza visual
        const toppingsContainer = card.querySelector(`#menu-pizza-${i}-toppings`);
        updatePizzaVisualForMenu(recipe, toppingsContainer);
      }
    }
    
    // Modified version of updatePizzaVisual for menu cards
    function updatePizzaVisualForMenu(ingredients, toppingsContainer) {
      toppingsContainer.innerHTML = '';
      
      const totalIngredients = Object.values(ingredients).reduce((sum, qty) => sum + qty, 0);
      
      Object.entries(ingredients).forEach(([ing, qty]) => {
        for (let i = 0; i < qty; i++) {
          const topping = document.createElement('div');
          topping.className = 'topping';
          topping.textContent = INGREDIENT_EMOJIS[ing];
          
          const angle = (i / qty) * Math.PI * 2;
          const radius = 60 * (1 - (totalIngredients - qty) / (totalIngredients * 2));
          const x = Math.cos(angle) * radius;
          const y = Math.sin(angle) * radius;
          
          topping.style.transform = `translate(${x}px, ${y}px)`;
          toppingsContainer.appendChild(topping);
        }
      });
    }
    
    // Modify updatePizzaCosts to also update the menu cards
    const originalUpdatePizzaCosts = updatePizzaCosts;
    updatePizzaCosts = function() {
      originalUpdatePizzaCosts();
      updatePizzaMenuCards();
    };
    
    // Initial setup of pizza menu cards
    updatePizzaMenuCards();
    
    // Update pizza menu cards when pizza names change
    document.getElementById('pizza-edit-done').onclick = function() {
      // Original modal close logic
      INGREDIENTS.forEach(ing => {
        const qty = parseInt(document.querySelector(`.pizza-edit-qty[data-ing='${ing}']`).textContent, 10);
        document.getElementById(`p${pizzaIndex+1}-${ing}`).value = qty;
      });
      document.getElementById(`p${pizzaIndex+1}-price`).value = parseInt(document.getElementById('pizza-edit-price').value, 10);
      const newName = document.getElementById('pizza-edit-title').value.trim() || `Pizza ${pizzaIndex+1}`;
      const pizzaLink = document.querySelector(`.pizza-edit-link[data-pizza='${pizzaIndex+1}']`);
      pizzaLink.textContent = newName;
      pizzaLink.setAttribute('data-pizza-name', newName);
      pizzaNames[pizzaIndex] = newName;
      updatePizzaCosts();
      document.getElementById('pizza-edit-modal').style.display = 'none';
      
      // Update the menu cards
      updatePizzaMenuCards();
    };
  </script>
</body>
</html> 