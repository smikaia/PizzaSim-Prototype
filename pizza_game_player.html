<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pizza Menu Game Prototype</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f8f8f8; }
    h1, h2 { color: #b33c00; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
    th { background: #ffe5b4; }
    input[type=number] { width: 50px; }
    .button { background: #b33c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    .button:hover { background: #d35400; }
    .button:disabled { background: #ccc; cursor: not-allowed; }
    .feedback { margin: 10px 0; padding: 10px; background: #fff3e0; border-left: 4px solid #b33c00; }
    .results { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    .simulation-controls { margin: 20px 0; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    .day-counter { font-size: 1.2em; font-weight: bold; color: #b33c00; margin-bottom: 10px; }
    .simulation-summary { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    .day-navigation { margin: 10px 0; }
    .day-navigation button { margin-right: 5px; }
    .cash-display {
      display: inline-block;
      padding: 10px 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #ccc;
      margin-left: 20px;
      font-size: 1.2em;
      font-weight: bold;
      color: #b33c00;
    }
    .cash-display.low {
      color: #ff0000;
    }
    .marketing-controls.disabled {
      opacity: 0.6;
      pointer-events: none;
    }
    /* Pizza Visualization Styles */
    .pizza-visual {
      width: 200px;
      height: 200px;
      background: #f4d03f;
      border-radius: 50%;
      position: relative;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border: 8px solid #e67e22;
      overflow: hidden;
    }
    
    .pizza-crust {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f4d03f;
      border-radius: 50%;
    }
    
    .pizza-sauce {
      position: absolute;
      top: 10%;
      left: 10%;
      right: 10%;
      bottom: 10%;
      background: #e74c3c;
      border-radius: 50%;
      opacity: 0.8;
    }
    
    .pizza-cheese {
      position: absolute;
      top: 15%;
      left: 15%;
      right: 15%;
      bottom: 15%;
      background: #f9e79f;
      border-radius: 50%;
      opacity: 0.9;
    }
    
    .pizza-toppings {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .topping {
      position: absolute;
      font-size: 24px;
      transition: all 0.3s ease;
    }
    
    .ingredient-preview {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 0.9em;
      color: #666;
    }
    
    .ingredient-preview span {
      font-size: 1.2em;
    }
    
    /* New Pizza Menu Card Styles */
    .pizza-menu-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: nowrap;
    }
    
    .pizza-card {
      background: #fff;
      border-radius: 16px;
      padding: 15px;
      width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
      position: relative;
      border: 2px solid #ffe5b4;
      flex-shrink: 0;
    }
    
    .pizza-card:hover {
      transform: translateY(-5px);
    }
    
    .pizza-card .pizza-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #b33c00;
      text-align: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #ffe5b4;
    }
    
    .pizza-card .pizza-visual {
      width: 140px;
      height: 140px;
      margin: 0 auto 12px;
    }
    
    .pizza-card .pizza-stats {
      background: #fff3e0;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
    }
    
    .pizza-card .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 1em;
    }
    
    .pizza-card .stat-label {
      color: #666;
    }
    
    .pizza-card .stat-value {
      font-weight: bold;
      color: #b33c00;
    }
    
    .pizza-card .edit-button {
      background: #b33c00;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      width: 100%;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 12px;
    }
    
    .pizza-card .edit-button:hover {
      background: #d35400;
    }
    
    /* Hide the original table but keep it for data management */
    #pizza-table {
      display: none;
    }
    /* --- Pizza Shop Interior Styles --- */
    #pizza-shop-interior {
      width: 100%;
      min-height: 380px;
      background: #2d5c4d;
      border-bottom: 8px solid #e67e22;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 0;
      margin-bottom: 32px;
      box-sizing: border-box;
    }
    .interior-flex {
      display: flex;
      width: 100%;
      max-width: 1200px;
      min-height: 380px;
    }
    .shop-street {
      width: 100px;
      background: #444c57;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      border-right: 6px solid #222;
      position: relative;
    }
    .street-bg {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .awning {
      width: 80px;
      height: 30px;
      display: flex;
      margin: 18px auto 8px auto;
      border-radius: 0 0 18px 18px;
      overflow: hidden;
      box-shadow: 0 2px 8px #2224;
    }
    .stripe {
      width: 26px;
      height: 100%;
    }
    .stripe.red { background: #d32f2f; }
    .stripe.white { background: #fff; }
    .open-sign {
      background: #ffe500;
      color: #222;
      font-weight: bold;
      font-size: 1.1em;
      border: 2px solid #bfae8e;
      border-radius: 6px;
      padding: 2px 10px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px #2222;
    }
    .sidewalk {
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(90deg, #888 0 8px, #aaa 8px 16px);
      position: absolute;
      bottom: 0;
      left: 0;
      z-index: 0;
      min-height: 60px;
    }
    .shop-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      min-height: 380px;
      background: #2d5c4d;
      margin-right: 20px;
    }
    
    /* Gameplay UI Section Styles */
    .gameplay-ui-section {
      width: 280px;
      background: #fffbe9;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border: 2px solid #ffe5b4;
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 380px;
    }
    
    .gameplay-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffe5b4;
    }
    
    .gameplay-top-row .day-counter {
      font-size: 1.1em;
      font-weight: bold;
      color: #b33c00;
      margin: 0;
    }
    
    .gameplay-top-row .cash-display {
      margin: 0;
      font-size: 1em;
      padding: 8px 12px;
    }
    
    .gameplay-daily-report {
      text-align: center;
    }
    
    .gameplay-edit-menu {
      text-align: center;
    }
    
    .gameplay-bottom-row {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }
    
    .gameplay-bottom-row .button {
      flex: 1;
      font-size: 0.9em;
      padding: 8px 12px;
    }
    .kitchen-row {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 32px;
      margin-top: 18px;
      margin-bottom: 8px;
    }
    .kitchen-station {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chef {
      font-size: 2em;
      margin-bottom: 2px;
    }
    .counter {
      width: 48px;
      height: 18px;
      background: #ffe5b4;
      border: 2px solid #bfae8e;
      border-radius: 6px;
      margin-bottom: 2px;
    }
    .interior-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      margin-bottom: 10px;
    }
    .plant {
      font-size: 1.5em;
    }
    .drink-machine {
      font-size: 1.5em;
      background: #b3e0c2;
      border-radius: 8px;
      padding: 2px 8px;
      border: 2px solid #fff;
    }
    .tables-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, 120px);
      grid-template-rows: repeat(2, 80px);
      grid-gap: 38px 48px;
      justify-content: center;
      align-items: center;
    }
    .table-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .table {
      width: 70px;
      height: 36px;
      background: #b3e0c2;
      border: 4px solid #fff;
      border-radius: 18px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      box-shadow: 0 2px 8px #2222;
    }
    .entrance-row {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      margin-top: 10px;
      margin-bottom: 8px;
    }
    .entrance-door {
      font-size: 2.2em;
      background: #ffe5b4;
      border-radius: 8px;
      border: 2px solid #bfae8e;
      padding: 2px 10px;
      box-shadow: 0 2px 8px #2222;
    }
    .customer-queue {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
      min-height: 180px;
      z-index: 2;
    }
    .customer-avatar {
      width: 48px;
      height: 70px;
      background: #fffbe9;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 1.7em;
      box-shadow: 0 1px 4px #2222;
      border: 2px solid #ffe5b4;
      margin-bottom: 8px;
      position: relative;
      transition: transform 0.7s cubic-bezier(.7,1.7,.5,1), opacity 0.5s;
      padding: 2px 0 0 0;
    }
    .customer-avatar.seated {
      margin-bottom: 0;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1.1);
      z-index: 3;
    }
    .avatar-img {
      width: 38px;
      height: 38px;
      object-fit: contain;
      margin-bottom: 2px;
      margin-top: 2px;
    }
    .avatar-label {
      font-size: 0.85em;
      color: #b33c00;
      background: #fff3e0;
      border-radius: 6px;
      padding: 1px 6px;
      margin-top: 2px;
      margin-bottom: 2px;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 1px 2px #ccc2;
    }
    .thought-bubble {
      position: absolute;
      left: 50%;
      top: -90px;
      transform: translateX(-50%);
      background: #fff;
      border-radius: 18px;
      padding: 6px 16px;
      color: #b33c00;
      font-size: 0.95em;
      box-shadow: 0 2px 8px #ccc;
      border: 2px solid #ffe5b4;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 10;
      min-width: 120px;
      margin-bottom: 8px;
    }
    .thought-bubble.visible {
      opacity: 1;
    }
    .bubble-pizza {
      font-size: 1em;
      color: #b33c00;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }
    .pizza-emoji {
      font-size: 1.1em;
    }
    .bubble-feedback {
      font-size: 0.95em;
      color: #7a3a00;
      margin-top: 2px;
    }
    @media (max-width: 700px) {
      .interior-flex { 
        max-width: 100vw; 
        flex-direction: column;
      }
      .shop-street { width: 60px; }
      .awning { width: 40px; height: 16px; }
      .stripe { width: 13px; }
      .open-sign { font-size: 0.8em; padding: 1px 4px; }
      .shop-grid { grid-template-columns: repeat(2, 70px); grid-template-rows: repeat(2, 40px); grid-gap: 12px 10px; }
      .table { width: 36px; height: 18px; font-size: 1em; }
      .entrance-door { font-size: 1.1em; padding: 1px 4px; }
      .gameplay-ui-section {
        width: 100%;
        margin-top: 20px;
        min-height: auto;
      }
      .gameplay-top-row {
        flex-direction: column;
        gap: 10px;
      }
      .gameplay-bottom-row {
        flex-direction: column;
      }
    }
    /* Daily Report Modal Styles */
    .daily-report-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .daily-report-content {
      background: #fffbe9;
      border-radius: 18px;
      box-shadow: 0 4px 24px #bfae8e;
      padding: 32px 40px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .daily-report-close {
      position: absolute;
      top: 18px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #b33c00;
    }
    
    .daily-report-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      border-bottom: 2px solid #ffe5b4;
      padding-bottom: 10px;
    }
    
    .daily-report-tab {
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #b33c00;
      transition: all 0.2s ease;
    }
    
    .daily-report-tab.active {
      background: #b33c00;
      color: white;
    }
    
    .daily-report-tab-content {
      display: none;
    }
    
    .daily-report-tab-content.active {
      display: block;
    }
    
    .sales-summary {
      font-size: 1.2em;
      font-weight: bold;
      color: #b33c00;
      margin-bottom: 24px;
      padding: 12px;
      background: #fff3e0;
      border-radius: 8px;
    }
    
    .pizza-sales-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    
    .pizza-sales-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #ffe5b4;
    }
    
    .pizza-sales-card .pizza-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #b33c00;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .pizza-sales-card .pizza-visual {
      width: 150px;
      height: 150px;
      margin: 0 auto 15px;
    }
    
    .pizza-sales-stats {
      background: #fff3e0;
      border-radius: 8px;
      padding: 12px;
    }
    
    .pizza-sales-stat {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 1.1em;
    }
    
    .satisfaction-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .segment-satisfaction-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #ffe5b4;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .segment-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 15px;
      border: 3px solid #ffe5b4;
      overflow: hidden;
    }
    
    .segment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .segment-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #b33c00;
      margin-bottom: 10px;
    }
    
    .satisfaction-score {
      font-size: 1.4em;
      font-weight: bold;
      color: #b33c00;
      background: #fff3e0;
      padding: 8px 16px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .satisfaction-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- Pizza Shop Interior Gameplay Area -->
  <div id="pizza-shop-interior">
    <div class="interior-flex">
      <!-- Street/Outside Area -->
      <div class="shop-street">
        <div class="street-bg">
          <div class="awning">
            <div class="stripe red"></div>
            <div class="stripe white"></div>
            <div class="stripe red"></div>
          </div>
          <div class="open-sign">OPEN</div>
          <div id="customer-queue" class="customer-queue"></div>
          <div class="sidewalk"></div>
        </div>
      </div>
      <!-- Shop Area -->
      <div class="shop-main">
        <!-- Kitchen Area -->
        <div class="kitchen-row">
          <div class="kitchen-station">
            <span class="chef">👨‍🍳</span>
            <div class="counter"></div>
          </div>
          <div class="kitchen-station">
            <span class="chef">👩‍🍳</span>
            <div class="counter"></div>
          </div>
          <div class="kitchen-station">
            <span class="chef">👨‍🍳</span>
            <div class="counter"></div>
          </div>
        </div>
        <!-- Plants and Drink Machines -->
        <div class="interior-row">
          <div class="plant">🪴</div>
          <div class="drink-machine">🥤</div>
          <div class="plant">🪴</div>
        </div>
        <!-- Tables Area -->
        <div class="tables-area">
          <div class="shop-grid" id="shop-grid">
            <div class="table-cell" data-table="0"><div class="table">🟦</div><div class="seated-customer"></div></div>
            <div class="table-cell" data-table="1"><div class="table">🟦</div><div class="seated-customer"></div></div>
            <div class="table-cell" data-table="2"><div class="table">🟦</div><div class="seated-customer"></div></div>
            <div class="table-cell" data-table="3"><div class="table">🟦</div><div class="seated-customer"></div></div>
          </div>
        </div>
        <!-- Entrance Door -->
        <div class="entrance-row">
          <div class="entrance-door">🚪</div>
        </div>
      </div>
      <!-- New Gameplay UI Section -->
      <div class="gameplay-ui-section">
        <!-- Top Row: Cash Display and Day Counter -->
        <div class="gameplay-top-row">
          <div class="day-counter" id="gameplay-day-counter">Day: <span id="current-day">1</span> of 5</div>
          <div class="cash-display" id="gameplay-cash-display">Cash: $100 USD</div>
        </div>
        
        <!-- Daily Report Button -->
        <div class="gameplay-daily-report">
          <button class="button" id="daily-report-button" onclick="showLastDailyReport()" disabled>Daily Report</button>
        </div>
        
        <!-- Edit Pizza Menu Button -->
        <div class="gameplay-edit-menu">
          <button class="button" id="edit-pizza-menu-button" onclick="openPizzaMenuModal()">Edit Pizza Menu</button>
        </div>
        
        <!-- Marketing Controls -->
        <div class="marketing-controls" style="margin: 15px 0; padding: 15px; background: #fff3e0; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #b33c00;">Marketing Activity (Optional)</h3>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px;">Activity Type:</label>
            <select id="marketing-type" style="padding: 5px; margin-right: 10px;">
              <option value="none">No Marketing</option>
              <option value="flyer">Flyer Drop ($5)</option>
              <option value="social">Social Media Ads ($15)</option>
              <option value="mascot">Street Mascot ($30)</option>
            </select>
            
            <select id="marketing-target" style="padding: 5px;" disabled>
              <option value="">Select Target Segment</option>
              <option value="Student">Students</option>
              <option value="Tourist">Tourists</option>
              <option value="Healthy Eater">Healthy Eaters</option>
              <option value="Gourmet Eater">Gourmet Eaters</option>
            </select>
          </div>
          <div id="marketing-cost" style="font-weight: bold; color: #b33c00;"></div>
        </div>
        
        <!-- Bottom Row: Simulate and Next Day Buttons -->
        <div class="gameplay-bottom-row">
          <button class="button" id="simulate-button" onclick="simulateDay()">Simulate Day</button>
          <button class="button" id="next-day-button" onclick="nextDay()" disabled>Next Day</button>
        </div>
      </div>
    </div>
  </div>
  <h1>Pizza Menu Game Prototype</h1>
  
  <!-- Hidden elements for data management -->
  <div style="display: none;">
    <table id="ingredients-table">
      <tr>
        <th>Ingredient</th>
        <th>Unit Cost (USD)</th>
      </tr>
      <tr><td>Cheese</td><td><input type="number" id="cost-cheese" value="1" min="1"></td></tr>
      <tr><td>Tomatoes</td><td><input type="number" id="cost-tomatoes" value="1" min="1"></td></tr>
      <tr><td>Veggies</td><td><input type="number" id="cost-veggies" value="1" min="1"></td></tr>
      <tr><td>Pepperoni</td><td><input type="number" id="cost-pepperoni" value="1" min="1"></td></tr>
    </table>

    <!-- Original table (hidden but kept for data management) -->
    <table id="pizza-table">
      <tr>
        <th>Pizza</th>
        <th>Cheese</th>
        <th>Tomatoes</th>
        <th>Veggies</th>
        <th>Pepperoni</th>
        <th>Price (USD)</th>
        <th>Total Cost (USD)</th>
        <th>Profit (USD)</th>
      </tr>
      <tr>
        <td><span class="pizza-edit-link" data-pizza="1" style="cursor:pointer; color:#b33c00; text-decoration:underline;">Pizza 1</span></td>
        <td><input type="number" id="p1-cheese" value="3" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p1-tomatoes" value="2" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p1-veggies" value="1" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p1-pepperoni" value="4" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p1-price" value="15" min="1" onchange="updatePizzaCosts()"></td>
        <td id="p1-cost">0</td>
        <td id="p1-profit">0</td>
      </tr>
      <tr>
        <td><span class="pizza-edit-link" data-pizza="2" style="cursor:pointer; color:#b33c00; text-decoration:underline;">Pizza 2</span></td>
        <td><input type="number" id="p2-cheese" value="0" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p2-tomatoes" value="1" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p2-veggies" value="4" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p2-pepperoni" value="2" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p2-price" value="13" min="1" onchange="updatePizzaCosts()"></td>
        <td id="p2-cost">0</td>
        <td id="p2-profit">0</td>
      </tr>
      <tr>
        <td><span class="pizza-edit-link" data-pizza="3" style="cursor:pointer; color:#b33c00; text-decoration:underline;">Pizza 3</span></td>
        <td><input type="number" id="p3-cheese" value="2" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p3-tomatoes" value="3" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p3-veggies" value="2" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p3-pepperoni" value="1" min="0" onchange="updatePizzaCosts()"></td>
        <td><input type="number" id="p3-price" value="12" min="1" onchange="updatePizzaCosts()"></td>
        <td id="p3-cost">0</td>
        <td id="p3-profit">0</td>
      </tr>
    </table>
  </div>

  <div class="simulation-controls" style="margin: 20px 0;">
    <button class="button" id="reset-button" onclick="resetSimulation()">Reset Simulation</button>
  </div>

  <div class="results" id="results" style="display:none;">
    <div class="day-navigation" id="day-navigation" style="display:none;">
      <button class="button" onclick="showPreviousDay()">Previous Day</button>
      <button class="button" onclick="showNextDay()">Next Day</button>
    </div>
    <div id="current-day-results"></div>
  </div>

  <div class="simulation-summary" id="simulation-summary" style="display:none;">
    <h2>Simulation Summary</h2>
    <div id="summary-content"></div>
  </div>

  <!-- Pizza Menu Modal -->
  <div id="pizza-menu-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fffbe9; border-radius:18px; box-shadow:0 4px 24px #bfae8e; padding:32px 40px; width:90%; max-width:1000px; max-height:90vh; overflow-y:auto; position:relative;">
      <button onclick="closePizzaMenuModal()" style="position:absolute; top:18px; right:18px; background:none; border:none; font-size:1.5em; cursor:pointer; color:#b33c00;">&times;</button>
      <h2 style="color:#b33c00; margin-bottom:24px; text-align:center;">Edit Pizza Menu</h2>
      <div class="pizza-menu-container" id="modal-pizza-menu-container">
        <!-- Pizza cards will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <!-- Minami Lane-style Pizza Edit Modal -->
  <div id="pizza-edit-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
    <div id="pizza-edit-content" style="background:#fffbe9; border-radius:18px; box-shadow:0 4px 24px #bfae8e; padding:32px 40px; min-width:380px; max-width:95vw; position:relative;">
      <button id="pizza-edit-close" style="position:absolute; top:18px; right:18px; background:none; border:none; font-size:1.5em; cursor:pointer; color:#b33c00;">&times;</button>
      <div style="display:flex; align-items:center; gap:18px; margin-bottom:18px;">
        <div id="pizza-edit-icon" style="width:64px; height:64px; background:#ffe5b4; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2.5em;">🍕</div>
        <div>
          <input id="pizza-edit-title" type="text" style="font-size:1.2em; font-weight:bold; color:#b33c00; background: #fffbe9; border: 1px solid #bfae8e; border-radius: 6px; padding: 4px 10px; width: 160px;" maxlength="32" />
        </div>
      </div>
      
      <!-- Add Pizza Visualization -->
      <div class="pizza-visual">
        <div class="pizza-crust"></div>
        <div class="pizza-sauce"></div>
        <div class="pizza-cheese"></div>
        <div class="pizza-toppings" id="pizza-toppings"></div>
      </div>
      
      <div style="margin-bottom:18px;">
        <div style="font-weight:bold; margin-bottom:8px;">Customize your pizza</div>
        <div id="pizza-edit-ingredients"></div>
      </div>
      <div style="margin-bottom:18px; display:flex; gap:24px; align-items:center;">
        <div>Total cost: <span id="pizza-edit-total-cost" style="font-weight:bold; color:#b33c00;"></span></div>
        <div>Profit: <span id="pizza-edit-profit" style="font-weight:bold; color:#b33c00;"></span></div>
      </div>
      <div style="margin-bottom:18px;">
        <label for="pizza-edit-price" style="font-weight:bold;">Selling price: $</label>
        <input type="number" id="pizza-edit-price" min="1" style="width:70px; padding:4px 8px; border-radius:6px; border:1px solid #ccc; font-size:1em;">
      </div>
      <button id="pizza-edit-done" class="button" style="width:100%; font-size:1.1em;">Done</button>
    </div>
  </div>

  <!-- Add Daily Report Modal HTML before closing body tag -->
  <div id="daily-report-modal" class="daily-report-modal">
    <div class="daily-report-content">
      <button class="daily-report-close" onclick="closeDailyReport()">&times;</button>
      <div style="text-align: center; margin-bottom: 24px;">
        <h1 style="color: #b33c00; margin: 0; font-size: 2em;">Day <span id="daily-report-day">1</span> Report</h1>
      </div>
      <div class="daily-report-tabs">
        <div class="daily-report-tab active" onclick="switchDailyReportTab('sales')">Sales</div>
        <div class="daily-report-tab" onclick="switchDailyReportTab('satisfaction')">Satisfaction</div>
      </div>
      
      <div id="sales-tab" class="daily-report-tab-content active">
        <div class="sales-summary">Total Profit for Today: $<span id="daily-total-profit">0</span> USD</div>
        <div id="pizza-sales-grid" class="pizza-sales-grid">
          <!-- Pizza sales cards will be inserted here -->
        </div>
      </div>
      
      <div id="satisfaction-tab" class="daily-report-tab-content">
        <div id="satisfaction-grid" class="satisfaction-grid">
          <!-- Segment satisfaction cards will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ingredient names
    const INGREDIENTS = ["cheese", "tomatoes", "veggies", "pepperoni"];

    // Customer segments
    const CUSTOMER_SEGMENTS = [
      {
        name: "Student",
        taste: { cheese: 2, tomatoes: 2, veggies: 1, pepperoni: 4 },
        priceMin: 12, priceMax: 15,
        totalCustomers: 40
      },
      {
        name: "Tourist",
        taste: { cheese: 3, tomatoes: 3, veggies: 2, pepperoni: 2 },
        priceMin: 14, priceMax: 18,
        totalCustomers: 30
      },
      {
        name: "Healthy Eater",
        taste: { cheese: 1, tomatoes: 3, veggies: 4, pepperoni: 0 },
        priceMin: 13, priceMax: 16,
        totalCustomers: 15
      },
      {
        name: "Gourmet Eater",
        taste: { cheese: 4, tomatoes: 2, veggies: 2, pepperoni: 3 },
        priceMin: 16, priceMax: 20,
        totalCustomers: 15
      }
    ];

    // Add first names for customers
    const CUSTOMER_FIRST_NAMES = [
      "Alex", "Sam", "Jordan", "Taylor", "Morgan", "Casey", "Riley", "Quinn", "Avery", "Drew",
      "Jamie", "Blake", "Cameron", "Dylan", "Emerson", "Finley", "Gray", "Harper", "Indigo", "Jules",
      "Kai", "Logan", "Mason", "Noah", "Owen", "Parker", "Quinn", "Ryan", "Sage", "Tyler",
      "Uma", "Violet", "Willow", "Xander", "Yuki", "Zion", "Aria", "Brooke", "Cody", "Dana",
      "Eden", "Felix", "Gwen", "Hazel", "Iris", "Jade", "Kira", "Luna", "Maya", "Nina"
    ];

    // Track which customers have visited
    let visitedCustomers = {
      "Student": new Set(),
      "Tourist": new Set(),
      "Healthy Eater": new Set(),
      "Gourmet Eater": new Set()
    };

    // Feedback templates
    const FEEDBACK = {
      cheese: [
        "could use more cheese!",
        "has too much cheese for my taste.",
        "perfect amount of cheese!"
      ],
      tomatoes: [
        "needs more tomatoes!",
        "has too many tomatoes.",
        "tomatoes are just right!"
      ],
      veggies: [
        "I wish there were more veggies.",
        "too many veggies for me.",
        "veggies are perfect!"
      ],
      pepperoni: [
        "more pepperoni would be great!",
        "too much pepperoni!",
        "pepperoni is spot on!"
      ],
      price: [
        "Price is too high for me.",
        "Great value for the price!",
        "Could be a bit cheaper."
      ]
    };

    // Track pizza names (default to Pizza 1, 2, 3)
    let pizzaNames = ["Pizza 1", "Pizza 2", "Pizza 3"];

    function getPizzaData() {
      // Get pizza recipes and prices from inputs
      let pizzas = [];
      for (let i = 1; i <= 3; i++) {
        let recipe = {};
        INGREDIENTS.forEach(ing => {
          recipe[ing] = parseInt(document.getElementById(`p${i}-${ing}`).value, 10);
        });
        let price = parseInt(document.getElementById(`p${i}-price`).value, 10);
        // Use pizzaNames array for the name
        let name = pizzaNames[i-1] || `Pizza ${i}`;
        pizzas.push({ name, recipe, price });
      }
      return pizzas;
    }

    function getIngredientCosts() {
      return {
        cheese: parseInt(document.getElementById('cost-cheese').value, 10),
        tomatoes: parseInt(document.getElementById('cost-tomatoes').value, 10),
        veggies: parseInt(document.getElementById('cost-veggies').value, 10),
        pepperoni: parseInt(document.getElementById('cost-pepperoni').value, 10)
      };
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Simulation state
    let currentDay = 1;
    let simulationComplete = false;
    let dayResults = [];
    let currentDayView = 1;

    // Marketing activity effects
    const MARKETING_EFFECTS = {
      flyer: 1.5,    // 50% increase in probability
      social: 2.0,   // 100% increase in probability
      mascot: 3.0    // 200% increase in probability
    };

    const MARKETING_COSTS = {
      flyer: 5,
      social: 15,
      mascot: 30
    };

    // Add cash management
    let playerCash = 100; // Starting cash

    function updateCashDisplay() {
      const cashDisplay = document.getElementById('gameplay-cash-display');
      cashDisplay.textContent = `Cash: $${playerCash} USD`;
      cashDisplay.classList.toggle('low', playerCash < 30); // Red if less than cheapest marketing
    }

    function updateMarketingControls() {
      const marketingType = document.getElementById('marketing-type');
      const marketingControls = document.querySelector('.marketing-controls');
      const simulateButton = document.getElementById('simulate-button');
      
      // Disable marketing controls if not enough cash
      if (playerCash < 5) {
        marketingControls.classList.add('disabled');
        if (marketingType.value !== 'none') {
          marketingType.value = 'none';
          document.getElementById('marketing-target').value = '';
          document.getElementById('marketing-target').disabled = true;
          document.getElementById('marketing-cost').textContent = '';
        }
      } else {
        marketingControls.classList.remove('disabled');
      }

      // Update available marketing options based on cash
      Array.from(marketingType.options).forEach(option => {
        if (option.value !== 'none') {
          const cost = MARKETING_COSTS[option.value];
          option.disabled = playerCash < cost;
        }
      });
    }

    // Update marketing type change handler
    document.getElementById('marketing-type').addEventListener('change', function() {
      const targetSelect = document.getElementById('marketing-target');
      const costDisplay = document.getElementById('marketing-cost');
      
      if (this.value === 'none') {
        targetSelect.disabled = true;
        targetSelect.value = '';
        costDisplay.textContent = '';
      } else {
        const cost = MARKETING_COSTS[this.value];
        if (playerCash >= cost) {
          targetSelect.disabled = false;
          targetSelect.value = ''; // Reset target selection
          costDisplay.textContent = `Cost: $${cost} USD - Don't forget to select the target segment`;
        } else {
          this.value = 'none';
          targetSelect.disabled = true;
          targetSelect.value = '';
          costDisplay.textContent = '';
        }
      }
    });

    // Update marketing target change handler
    document.getElementById('marketing-target').addEventListener('change', function() {
      const marketingType = document.getElementById('marketing-type').value;
      const costDisplay = document.getElementById('marketing-cost');
      
      if (this.value && marketingType !== 'none') {
        const cost = MARKETING_COSTS[marketingType];
        costDisplay.textContent = `Cost: $${cost} USD - Ready to launch!`;
      }
    });

    // Customer segment avatars (PNG mapping)
    const SEGMENT_AVATARS = {
      'Student': 'avatar_assets/character-male-a.png',
      'Tourist': 'avatar_assets/character-male-b.png',
      'Healthy Eater': 'avatar_assets/character-female-e.png',
      'Gourmet Eater': 'avatar_assets/character-female-f.png'
    };

    // Animate a single customer: walk in, sit, show feedback, leave
    async function animateCustomer(customer, feedback, tableIdx, pizzaName) {
      return new Promise(resolve => {
        // 1. Add avatar to queue
        const queue = document.getElementById('customer-queue');
        const avatar = document.createElement('div');
        avatar.className = 'customer-avatar';
        // Use PNG image for avatar
        const img = document.createElement('img');
        img.src = SEGMENT_AVATARS[customer.segmentName];
        img.alt = customer.segmentName;
        img.className = 'avatar-img';
        avatar.appendChild(img);
        // Add segment label
        const label = document.createElement('div');
        label.className = 'avatar-label';
        label.textContent = `${customer.firstName} (${customer.segmentName})`;
        avatar.appendChild(label);
        queue.appendChild(avatar);

        // 2. Wait a bit, then move to table
        setTimeout(() => {
          // Remove from queue
          avatar.style.opacity = 0;
          setTimeout(() => {
            queue.removeChild(avatar);
            // Add to table
            const tableCell = document.querySelector(`.table-cell[data-table='${tableIdx}'] .seated-customer`);
            avatar.className = 'customer-avatar seated';
            avatar.style.opacity = 1;
            tableCell.appendChild(avatar);
            // 3. Show thought bubble after a short delay
            setTimeout(() => {
              const bubble = document.createElement('div');
              bubble.className = 'thought-bubble visible';
              // Show pizza name and feedback
              bubble.innerHTML = `<div class='bubble-pizza'><span class='pizza-emoji'>🍕</span> <b>${pizzaName}</b></div><div class='bubble-feedback'>${feedback}</div>`;
              avatar.appendChild(bubble);
              // 4. Wait, then remove avatar and bubble
              setTimeout(() => {
                bubble.classList.remove('visible');
                setTimeout(() => {
                  tableCell.removeChild(avatar);
                  resolve();
                }, 400);
              }, 1600);
            }, 600);
          }, 400);
        }, 400);
      });
    }

    // Refactor simulateDay to animate customers
    async function simulateDay() {
      if (currentDay > 5 || simulationComplete) return;
      // Clear any previous avatars
      document.querySelectorAll('.seated-customer').forEach(cell => cell.innerHTML = '');
      document.getElementById('customer-queue').innerHTML = '';

      const pizzas = getPizzaData();
      const ingredientCosts = getIngredientCosts();
      let customers = [];
      const tableCount = 4;
      let tableAvailable = [true, true, true, true];
      
      // Get marketing selection and verify cash
      const marketingType = document.getElementById('marketing-type').value;
      const marketingTarget = document.getElementById('marketing-target').value;
      let marketingCost = 0;
      let marketingEffect = 1;
      
      // Validate marketing selection
      if (marketingType !== 'none' && !marketingTarget) {
        alert('Please select a target segment for your marketing activity!');
        return;
      }
      
      if (marketingType !== 'none' && marketingTarget) {
        marketingCost = MARKETING_COSTS[marketingType];
        if (playerCash < marketingCost) {
          alert('Not enough cash for selected marketing activity!');
          return;
        }
        marketingEffect = MARKETING_EFFECTS[marketingType];
      }
      
      // Select customers with marketing effects
      let availableCustomers = [];
      CUSTOMER_SEGMENTS.forEach(segment => {
        for (let i = 1; i <= segment.totalCustomers; i++) {
          if (!visitedCustomers[segment.name].has(i)) {
            // Apply marketing effect to target segment
            let weight = segment.name === marketingTarget ? marketingEffect : 1;
            availableCustomers.push({ segment, customerId: i, weight });
          }
        }
      });

      // If we have less than 10 available customers, reset the visited customers
      if (availableCustomers.length < 10) {
        CUSTOMER_SEGMENTS.forEach(segment => {
          visitedCustomers[segment.name].clear();
        });
        availableCustomers = [];
        CUSTOMER_SEGMENTS.forEach(segment => {
          for (let i = 1; i <= segment.totalCustomers; i++) {
            let weight = segment.name === marketingTarget ? marketingEffect : 1;
            availableCustomers.push({ segment, customerId: i, weight });
          }
        });
      }

      // Weighted random selection of customers
      let totalWeight = availableCustomers.reduce((sum, c) => sum + c.weight, 0);
      for (let i = 0; i < 10; i++) {
        if (availableCustomers.length === 0) break;
        
        // Weighted random selection
        let random = Math.random() * totalWeight;
        let selectedIndex = 0;
        let weightSum = 0;
        
        for (let j = 0; j < availableCustomers.length; j++) {
          weightSum += availableCustomers[j].weight;
          if (random <= weightSum) {
            selectedIndex = j;
            break;
          }
        }
        
        const selected = availableCustomers.splice(selectedIndex, 1)[0];
        customers.push({ 
          id: selected.customerId, 
          segment: selected.segment,
          segmentName: selected.segment.name,
          firstName: CUSTOMER_FIRST_NAMES[selected.customerId - 1] // Add first name based on customer ID
        });
        visitedCustomers[selected.segment.name].add(selected.customerId);
        
        // Update total weight
        totalWeight -= selected.weight;
      }

      let dayResult = {
        day: currentDay,
        customers: [],
        totalSatisfaction: 0,
        dailyProfit: 0,
        segmentSatisfaction: {},
        segmentCounts: {},
        segmentTotalServed: {},
        marketing: marketingType !== 'none' ? {
          type: marketingType,
          target: marketingTarget,
          cost: marketingCost
        } : null
      };

      // Initialize segment tracking
      CUSTOMER_SEGMENTS.forEach(seg => {
        dayResult.segmentSatisfaction[seg.name] = 0;
        dayResult.segmentCounts[seg.name] = 0;
        // Calculate total customers served so far for each segment
        dayResult.segmentTotalServed[seg.name] = visitedCustomers[seg.name].size;
      });

      let resultsHTML = `<h2>Day ${currentDay} Results</h2>`;
      resultsHTML += `<table><tr><th>Customer</th><th>Segment</th><th>Pizza Chosen</th><th>Feedback</th><th>Satisfaction</th></tr>`;

      for (let i = 0; i < customers.length; i++) {
        // Find first available table
        let tableIdx = tableAvailable.findIndex(x => x);
        if (tableIdx === -1) tableIdx = 0; // fallback
        tableAvailable[tableIdx] = false;

        // Find best pizza for this customer
        let bestPizza = null;
        let bestScore = -Infinity;
        let bestDiff = null;
        pizzas.forEach(pizza => {
          // Calculate taste match (lower is better)
          let tasteDiff = 0;
          INGREDIENTS.forEach(ing => {
            tasteDiff += Math.abs(pizza.recipe[ing] - customers[i].segment.taste[ing]);
          });
          // Calculate price match (0 if in range, else penalty)
          let pricePenalty = 0;
          if (pizza.price < customers[i].segment.priceMin) pricePenalty = customers[i].segment.priceMin - pizza.price;
          else if (pizza.price > customers[i].segment.priceMax) pricePenalty = pizza.price - customers[i].segment.priceMax;
          // Lower total diff is better
          let totalDiff = tasteDiff + pricePenalty;
          // For tie-breaking, prefer lower price
          let score = -totalDiff - pizza.price * 0.01;
          if (score > bestScore) {
            bestScore = score;
            bestPizza = pizza;
            bestDiff = { tasteDiff, pricePenalty, pizza };
          }
        });
        // Feedback: find biggest difference
        let maxIng = null, maxDiff = 0;
        INGREDIENTS.forEach(ing => {
          let diff = Math.abs(bestPizza.recipe[ing] - customers[i].segment.taste[ing]);
          if (diff > maxDiff) { maxDiff = diff; maxIng = ing; }
        });
        let priceDiff = 0;
        if (bestPizza.price < customers[i].segment.priceMin) priceDiff = customers[i].segment.priceMin - bestPizza.price;
        else if (bestPizza.price > customers[i].segment.priceMax) priceDiff = bestPizza.price - customers[i].segment.priceMax;
        // Decide if price or ingredient is most critical
        let feedback = "";
        // If perfect match, give special feedback
        if (bestDiff.tasteDiff === 0 && bestDiff.pricePenalty === 0) {
          feedback = `This pizza (${bestPizza.name}) is perfect for me!`;
        } else if (priceDiff > maxDiff) {
          if (bestPizza.price > customers[i].segment.priceMax) {
            feedback = FEEDBACK.price[0]; // "Price is too high for me."
          } else if (bestPizza.price < customers[i].segment.priceMin) {
            feedback = "This pizza is too cheap for me.";
          } else {
            feedback = FEEDBACK.price[2]; // "Could be a bit cheaper."
          }
        } else if (maxDiff > 0) {
          let ing = maxIng;
          if (bestPizza.recipe[ing] > customers[i].segment.taste[ing]) feedback = FEEDBACK[ing][1];
          else feedback = FEEDBACK[ing][0];
        } else {
          feedback = FEEDBACK[INGREDIENTS[randomInt(0,3)]][2];
        }
        // Satisfaction: base 10, minus taste and price penalties
        let satisfaction = 10 - bestDiff.tasteDiff - bestDiff.pricePenalty;
        if (satisfaction < 1) satisfaction = 1;
        if (satisfaction > 10) satisfaction = 10;
        dayResult.totalSatisfaction += satisfaction;
        dayResult.segmentSatisfaction[customers[i].segmentName] += satisfaction;
        dayResult.segmentCounts[customers[i].segmentName] += 1;
        // Calculate profit for this pizza sale
        let pizzaCost = 0;
        INGREDIENTS.forEach(ing => {
          pizzaCost += bestPizza.recipe[ing] * ingredientCosts[ing];
        });
        let pizzaProfit = bestPizza.price - pizzaCost;
        dayResult.dailyProfit += pizzaProfit;
        // Store customer result
        dayResult.customers.push({
          id: customers[i].id,
          segment: customers[i].segmentName,
          pizza: bestPizza.name,
          pizzaIndex: pizzas.indexOf(bestPizza), // store index for robustness
          feedback: feedback,
          satisfaction: satisfaction
        });
        resultsHTML += `<tr><td>${customers[i].firstName} (C${customers[i].id})</td><td>${customers[i].segmentName}</td><td>${bestPizza.name}</td><td>${feedback}</td><td>${satisfaction}</td></tr>`;

        // Animate customer
        await animateCustomer(customers[i], feedback, tableIdx, bestPizza.name);
        tableAvailable[tableIdx] = true;
      }

      resultsHTML += `</table>`;
      resultsHTML += `<p><b>Average Satisfaction:</b> ${(dayResult.totalSatisfaction/10).toFixed(2)} / 10</p>`;
      resultsHTML += `<p><b>Daily Profit:</b> $${dayResult.dailyProfit} USD</p>`;
      
      resultsHTML += `<h3>Average Satisfaction by Segment</h3><ul>`;
      CUSTOMER_SEGMENTS.forEach(seg => {
        let avgSatisfaction = dayResult.segmentCounts[seg.name] > 0 ? 
          (dayResult.segmentSatisfaction[seg.name] / dayResult.segmentCounts[seg.name]) : 0;
        
        // Calculate segment coverage (percentage of total segment served)
        let coverage = (dayResult.segmentTotalServed[seg.name] / seg.totalCustomers) * 100;
        
        // Calculate weighted satisfaction (satisfaction * coverage)
        let weightedSatisfaction = avgSatisfaction * (coverage / 100);
        
        resultsHTML += `<li><b>${seg.name}:</b> ${avgSatisfaction.toFixed(2)} / 10 (${coverage.toFixed(1)}% of segment served, weighted: ${weightedSatisfaction.toFixed(2)})</li>`;
      });
      resultsHTML += `</ul>`;

      // Update cash and profit
      dayResult.dailyProfit -= marketingCost;
      playerCash += dayResult.dailyProfit;
      updateCashDisplay();
      updateMarketingControls();

      // Update results display to show cash
      if (marketingType !== 'none') {
        resultsHTML = `<div class="feedback" style="margin-bottom: 15px;">
          <b>Remaining Cash:</b> $${playerCash} USD
        </div>` + resultsHTML;
      } else {
        resultsHTML = `<div class="feedback" style="margin-bottom: 15px;">
          <b>Remaining Cash:</b> $${playerCash} USD
        </div>` + resultsHTML;
      }

      // Store the day's results
      dayResults[currentDay - 1] = dayResult;
      document.getElementById('current-day-results').innerHTML = resultsHTML;
      document.getElementById('results').style.display = 'block';
      document.getElementById('day-navigation').style.display = 'block';
      
      // Update simulation state
      document.getElementById('simulate-button').disabled = true;
      document.getElementById('next-day-button').disabled = false;
      
      if (currentDay === 5) {
        simulationComplete = true;
        document.getElementById('next-day-button').disabled = true;
        updateSimulationSummary();
      }

      // Show daily report
      showDailyReport(dayResult);
    }

    function nextDay() {
      if (currentDay < 5 && !simulationComplete) {
        currentDay++;
        currentDayView = currentDay;
        document.getElementById('current-day').textContent = currentDay;
        document.getElementById('simulate-button').disabled = false;
        document.getElementById('next-day-button').disabled = true;
        document.getElementById('results').style.display = 'none';
        document.getElementById('marketing-type').value = 'none';
        document.getElementById('marketing-target').value = '';
        document.getElementById('marketing-target').disabled = true;
        document.getElementById('marketing-cost').textContent = '';
        updateMarketingControls();
      }
    }

    function resetSimulation() {
      currentDay = 1;
      currentDayView = 1;
      simulationComplete = false;
      dayResults = [];
      lastDailyReport = null; // Clear the last report
      // Reset visited customers tracking
      CUSTOMER_SEGMENTS.forEach(segment => {
        visitedCustomers[segment.name].clear();
      });
      document.getElementById('current-day').textContent = currentDay;
      document.getElementById('simulate-button').disabled = false;
      document.getElementById('next-day-button').disabled = true;
      document.getElementById('daily-report-button').disabled = true; // Disable the button
      document.getElementById('results').style.display = 'none';
      document.getElementById('simulation-summary').style.display = 'none';
      document.getElementById('marketing-type').value = 'none';
      document.getElementById('marketing-target').value = '';
      document.getElementById('marketing-target').disabled = true;
      document.getElementById('marketing-cost').textContent = '';
      playerCash = 100;
      updateCashDisplay();
      updateMarketingControls();
    }

    function showPreviousDay() {
      if (currentDayView > 1) {
        currentDayView--;
        displayDayResults(currentDayView);
      }
    }

    function showNextDay() {
      if (currentDayView < currentDay) {
        currentDayView++;
        displayDayResults(currentDayView);
      }
    }

    function displayDayResults(day) {
      if (dayResults[day - 1]) {
        const result = dayResults[day - 1];
        let resultsHTML = `<h2>Day ${day} Results</h2>`;
        resultsHTML += `<table><tr><th>Customer</th><th>Segment</th><th>Pizza Chosen</th><th>Feedback</th><th>Satisfaction</th></tr>`;
        
        result.customers.forEach(customer => {
          // Use the pizzaNames array for the current name
          let pizzaName = pizzaNames[customer.pizzaIndex] || customer.pizza;
          resultsHTML += `<tr><td>${customer.firstName} (C${customer.id})</td><td>${customer.segment}</td><td>${pizzaName}</td><td>${customer.feedback}</td><td>${customer.satisfaction}</td></tr>`;
        });
        
        resultsHTML += `</table>`;
        resultsHTML += `<p><b>Average Satisfaction:</b> ${(result.totalSatisfaction/10).toFixed(2)} / 10</p>`;
        resultsHTML += `<p><b>Daily Profit:</b> $${result.dailyProfit} USD</p>`;
        
        resultsHTML += `<h3>Average Satisfaction by Segment</h3><ul>`;
        CUSTOMER_SEGMENTS.forEach(seg => {
          let avg = result.segmentCounts[seg.name] > 0 ? 
            (result.segmentSatisfaction[seg.name] / result.segmentCounts[seg.name]).toFixed(2) : 'N/A';
          resultsHTML += `<li><b>${seg.name}:</b> ${avg} / 10</li>`;
        });
        resultsHTML += `</ul>`;
        
        document.getElementById('current-day-results').innerHTML = resultsHTML;
        document.getElementById('results').style.display = 'block';
      }
    }

    function updateSimulationSummary() {
      if (dayResults.length === 0) return;
      
      let totalProfit = 0;
      let totalSatisfaction = 0;
      let bestPizzaByDay = [];
      let segmentTrends = {};
      let segmentCoverage = {};
      
      CUSTOMER_SEGMENTS.forEach(seg => {
        segmentTrends[seg.name] = [];
        segmentCoverage[seg.name] = [];
      });
      
      dayResults.forEach((day, index) => {
        totalProfit += day.dailyProfit;
        totalSatisfaction += day.totalSatisfaction;
        
        // Find best performing pizza for the day
        let pizzaSales = {};
        day.customers.forEach(customer => {
          pizzaSales[customer.pizza] = (pizzaSales[customer.pizza] || 0) + 1;
        });
        let bestPizza = Object.entries(pizzaSales).sort((a, b) => b[1] - a[1])[0][0];
        bestPizzaByDay.push({ day: index + 1, pizza: bestPizza });
        
        // Track segment satisfaction and coverage trends
        CUSTOMER_SEGMENTS.forEach(seg => {
          let avg = day.segmentCounts[seg.name] > 0 ? 
            (day.segmentSatisfaction[seg.name] / day.segmentCounts[seg.name]) : 0;
          let coverage = (day.segmentTotalServed[seg.name] / seg.totalCustomers) * 100;
          segmentTrends[seg.name].push(avg);
          segmentCoverage[seg.name].push(coverage);
        });
      });
      
      let summaryHTML = `
        <p><b>Total Profit:</b> $${totalProfit} USD</p>
        <p><b>Average Satisfaction:</b> ${(totalSatisfaction/(dayResults.length * 10)).toFixed(2)} / 10</p>
        
        <h3>Best Performing Pizza by Day</h3>
        <ul>
          ${bestPizzaByDay.map(day => `<li>Day ${day.day}: ${day.pizza}</li>`).join('')}
        </ul>
        
        <h3>Customer Segment Analysis</h3>
        <ul>
          ${CUSTOMER_SEGMENTS.map(seg => `
            <li><b>${seg.name}:</b><br>
                Satisfaction: ${segmentTrends[seg.name].map(s => s.toFixed(2)).join(' → ')}<br>
                Coverage: ${segmentCoverage[seg.name].map(c => c.toFixed(1) + '%').join(' → ')}<br>
                Final Weighted Score: ${(segmentTrends[seg.name][segmentTrends[seg.name].length-1] * 
                (segmentCoverage[seg.name][segmentCoverage[seg.name].length-1]/100)).toFixed(2)} / 10
            </li>
          `).join('')}
        </ul>
      `;
      
      document.getElementById('summary-content').innerHTML = summaryHTML;
      document.getElementById('simulation-summary').style.display = 'block';
    }

    // Update pizza costs and profits
    function updatePizzaCosts() {
      const ingredientCosts = getIngredientCosts();
      for (let i = 1; i <= 3; i++) {
        let totalCost = 0;
        INGREDIENTS.forEach(ing => {
          const qty = parseInt(document.getElementById(`p${i}-${ing}`).value, 10);
          totalCost += qty * ingredientCosts[ing];
        });
        const price = parseInt(document.getElementById(`p${i}-price`).value, 10);
        const profit = price - totalCost;
        document.getElementById(`p${i}-cost`).textContent = totalCost;
        document.getElementById(`p${i}-profit`).textContent = profit;
      }
    }
    // Update costs when ingredient unit costs change
    document.getElementById('cost-cheese').addEventListener('change', updatePizzaCosts);
    document.getElementById('cost-tomatoes').addEventListener('change', updatePizzaCosts);
    document.getElementById('cost-veggies').addEventListener('change', updatePizzaCosts);
    document.getElementById('cost-pepperoni').addEventListener('change', updatePizzaCosts);
    // Initial update
    updatePizzaCosts();

    // Initial setup
    updateCashDisplay();
    updateMarketingControls();

    // --- Pizza Edit Modal Logic ---
    const PIZZA_ICONS = ['🍕','🍕','🍕']; // You can use different icons if you want
    // Add ingredient emojis mapping
    const INGREDIENT_EMOJIS = {
      cheese: '🧀',
      tomatoes: '🍅',
      veggies: '🥬',
      pepperoni: '🍖'
    };
    
    // Add ingredient colors for visual feedback
    const INGREDIENT_COLORS = {
      cheese: '#f9e79f',
      tomatoes: '#e74c3c',
      veggies: '#2ecc71',
      pepperoni: '#c0392b'
    };
    
    function updatePizzaVisual(ingredients) {
      const toppingsContainer = document.getElementById('pizza-toppings');
      toppingsContainer.innerHTML = '';
      
      // Calculate total ingredients for scaling
      const totalIngredients = Object.values(ingredients).reduce((sum, qty) => sum + qty, 0);
      
      // Add toppings based on quantities
      Object.entries(ingredients).forEach(([ing, qty]) => {
        for (let i = 0; i < qty; i++) {
          const topping = document.createElement('div');
          topping.className = 'topping';
          topping.textContent = INGREDIENT_EMOJIS[ing];
          
          // Position toppings in a spiral pattern
          const angle = (i / qty) * Math.PI * 2;
          const radius = 70 * (1 - (totalIngredients - qty) / (totalIngredients * 2));
          const x = Math.cos(angle) * radius;
          const y = Math.sin(angle) * radius;
          
          topping.style.transform = `translate(${x}px, ${y}px)`;
          toppingsContainer.appendChild(topping);
        }
      });
    }
    
    function openPizzaEditModal(pizzaIndex) {
      const pizzas = getPizzaData();
      const ingredientCosts = getIngredientCosts();
      const pizza = pizzas[pizzaIndex];
      document.getElementById('pizza-edit-title').value = pizzaNames[pizzaIndex];
      document.getElementById('pizza-edit-icon').textContent = PIZZA_ICONS[pizzaIndex];
      
      // Build ingredient controls
      const ingDiv = document.getElementById('pizza-edit-ingredients');
      ingDiv.innerHTML = '';
      
      // Initial pizza visualization
      updatePizzaVisual(pizza.recipe);
      
      INGREDIENTS.forEach(ing => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.marginBottom = '15px';
        row.innerHTML = `
          <span style="width:120px; display:inline-block; font-weight:bold; color:#b33c00;">
            ${INGREDIENT_EMOJIS[ing]} ${ing.charAt(0).toUpperCase()+ing.slice(1)}
          </span>
          <button class="pizza-edit-minus" data-ing="${ing}" style="background:#ffe5b4; border:none; border-radius:50%; width:32px; height:32px; font-size:1.3em; color:#b33c00; margin:0 8px;">-</button>
          <span class="pizza-edit-qty" data-ing="${ing}" style="min-width:24px; display:inline-block; text-align:center; font-size:1.1em;">${pizza.recipe[ing]}</span>
          <button class="pizza-edit-plus" data-ing="${ing}" style="background:#ffe5b4; border:none; border-radius:50%; width:32px; height:32px; font-size:1.3em; color:#b33c00; margin:0 8px;">+</button>
          <span style="margin-left:8px; color:#888;">$${ingredientCosts[ing]}</span>
        `;
        ingDiv.appendChild(row);
      });
      
      // Set price
      document.getElementById('pizza-edit-price').value = pizza.price;
      // Update cost/profit
      function updateModalCostProfit() {
        let totalCost = 0;
        INGREDIENTS.forEach(ing => {
          const qty = parseInt(document.querySelector(`.pizza-edit-qty[data-ing='${ing}']`).textContent, 10);
          totalCost += qty * ingredientCosts[ing];
        });
        const price = parseInt(document.getElementById('pizza-edit-price').value, 10);
        document.getElementById('pizza-edit-total-cost').textContent = `$${totalCost}`;
        document.getElementById('pizza-edit-profit').textContent = `$${price - totalCost}`;
      }
      updateModalCostProfit();
      // + and - button handlers
      ingDiv.querySelectorAll('.pizza-edit-minus').forEach(btn => {
        btn.onclick = function() {
          const ing = btn.getAttribute('data-ing');
          const qtySpan = ingDiv.querySelector(`.pizza-edit-qty[data-ing='${ing}']`);
          let qty = parseInt(qtySpan.textContent, 10);
          if (qty > 0) qty--;
          qtySpan.textContent = qty;
          
          // Update visual pizza
          const currentIngredients = {};
          INGREDIENTS.forEach(i => {
            currentIngredients[i] = parseInt(ingDiv.querySelector(`.pizza-edit-qty[data-ing='${i}']`).textContent, 10);
          });
          updatePizzaVisual(currentIngredients);
          
          updateModalCostProfit();
        };
      });
      ingDiv.querySelectorAll('.pizza-edit-plus').forEach(btn => {
        btn.onclick = function() {
          const ing = btn.getAttribute('data-ing');
          const qtySpan = ingDiv.querySelector(`.pizza-edit-qty[data-ing='${ing}']`);
          let qty = parseInt(qtySpan.textContent, 10);
          qty++;
          qtySpan.textContent = qty;
          
          // Update visual pizza
          const currentIngredients = {};
          INGREDIENTS.forEach(i => {
            currentIngredients[i] = parseInt(ingDiv.querySelector(`.pizza-edit-qty[data-ing='${i}']`).textContent, 10);
          });
          updatePizzaVisual(currentIngredients);
          
          updateModalCostProfit();
        };
      });
      document.getElementById('pizza-edit-price').oninput = updateModalCostProfit;
      // Show modal
      document.getElementById('pizza-edit-modal').style.display = 'flex';
      // Done button handler
      document.getElementById('pizza-edit-done').onclick = function() {
        // Write back to main table
        INGREDIENTS.forEach(ing => {
          const qty = parseInt(ingDiv.querySelector(`.pizza-edit-qty[data-ing='${ing}']`).textContent, 10);
          document.getElementById(`p${pizzaIndex+1}-${ing}`).value = qty;
        });
        document.getElementById(`p${pizzaIndex+1}-price`).value = parseInt(document.getElementById('pizza-edit-price').value, 10);
        // Update pizza name in the main table
        const newName = document.getElementById('pizza-edit-title').value.trim() || `Pizza ${pizzaIndex+1}`;
        // Update the clickable pizza name in the table
        const pizzaLink = document.querySelector(`.pizza-edit-link[data-pizza='${pizzaIndex+1}']`);
        pizzaLink.textContent = newName;
        pizzaLink.setAttribute('data-pizza-name', newName);
        pizzaNames[pizzaIndex] = newName;
        updatePizzaCosts();
        document.getElementById('pizza-edit-modal').style.display = 'none';
      };
    }
    // Close modal handler
    document.getElementById('pizza-edit-close').onclick = function() {
      document.getElementById('pizza-edit-modal').style.display = 'none';
    };
    // Open modal on pizza name click
    document.querySelectorAll('.pizza-edit-link').forEach(link => {
      link.onclick = function() {
        const idx = parseInt(link.getAttribute('data-pizza'), 10) - 1;
        openPizzaEditModal(idx);
        // If a custom name was set, use it
        const customName = link.getAttribute('data-pizza-name');
        if (customName) {
          document.getElementById('pizza-edit-title').value = customName;
        }
      };
    });

    // Add function to update pizza menu cards (now only updates modal)
    function updatePizzaMenuCards() {
      // This function is now deprecated since we only use the modal
      // The modal is updated separately via updateModalPizzaMenuCards()
      return;
    }
    
    // Add function to update modal pizza menu cards
    function updateModalPizzaMenuCards() {
      const container = document.getElementById('modal-pizza-menu-container');
      container.innerHTML = '';
      
      for (let i = 1; i <= 3; i++) {
        const pizzaName = pizzaNames[i-1] || `Pizza ${i}`;
        const totalCost = document.getElementById(`p${i}-cost`).textContent;
        const price = document.getElementById(`p${i}-price`).value;
        const profit = document.getElementById(`p${i}-profit`).textContent;
        
        // Get current recipe
        const recipe = {};
        INGREDIENTS.forEach(ing => {
          recipe[ing] = parseInt(document.getElementById(`p${i}-${ing}`).value, 10);
        });
        
        const card = document.createElement('div');
        card.className = 'pizza-card';
        card.innerHTML = `
          <div class="pizza-name">${pizzaName}</div>
          <div class="pizza-visual">
            <div class="pizza-crust"></div>
            <div class="pizza-sauce"></div>
            <div class="pizza-cheese"></div>
            <div class="pizza-toppings" id="modal-menu-pizza-${i}-toppings"></div>
          </div>
          <div class="pizza-stats">
            <div class="stat-row">
              <span class="stat-label">Total Cost:</span>
              <span class="stat-value">$${totalCost}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Price:</span>
              <span class="stat-value">$${price}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Profit:</span>
              <span class="stat-value">$${profit}</span>
            </div>
          </div>
          <button class="edit-button" onclick="openPizzaEditModal(${i-1})">Edit Pizza</button>
        `;
        
        container.appendChild(card);
        
        // Update pizza visual
        const toppingsContainer = card.querySelector(`#modal-menu-pizza-${i}-toppings`);
        updatePizzaVisualForMenu(recipe, toppingsContainer);
      }
    }
    
    // Pizza Menu Modal Functions
    function openPizzaMenuModal() {
      updateModalPizzaMenuCards();
      document.getElementById('pizza-menu-modal').style.display = 'flex';
    }
    
    function closePizzaMenuModal() {
      document.getElementById('pizza-menu-modal').style.display = 'none';
    }
    
    // Modified version of updatePizzaVisual for menu cards
    function updatePizzaVisualForMenu(ingredients, toppingsContainer) {
      toppingsContainer.innerHTML = '';
      
      const totalIngredients = Object.values(ingredients).reduce((sum, qty) => sum + qty, 0);
      
      Object.entries(ingredients).forEach(([ing, qty]) => {
        for (let i = 0; i < qty; i++) {
          const topping = document.createElement('div');
          topping.className = 'topping';
          topping.textContent = INGREDIENT_EMOJIS[ing];
          
          const angle = (i / qty) * Math.PI * 2;
          const radius = 60 * (1 - (totalIngredients - qty) / (totalIngredients * 2));
          const x = Math.cos(angle) * radius;
          const y = Math.sin(angle) * radius;
          
          topping.style.transform = `translate(${x}px, ${y}px)`;
          toppingsContainer.appendChild(topping);
        }
      });
    }
    
    // Modify updatePizzaCosts to also update the menu cards
    const originalUpdatePizzaCosts = updatePizzaCosts;
    updatePizzaCosts = function() {
      originalUpdatePizzaCosts();
      updateModalPizzaMenuCards();
    };
    
    // Initial setup - no longer needed since we use modal
    
    // Update pizza menu cards when pizza names change
    document.getElementById('pizza-edit-done').onclick = function() {
      // Original modal close logic
      INGREDIENTS.forEach(ing => {
        const qty = parseInt(document.querySelector(`.pizza-edit-qty[data-ing='${ing}']`).textContent, 10);
        document.getElementById(`p${pizzaIndex+1}-${ing}`).value = qty;
      });
      document.getElementById(`p${pizzaIndex+1}-price`).value = parseInt(document.getElementById('pizza-edit-price').value, 10);
      const newName = document.getElementById('pizza-edit-title').value.trim() || `Pizza ${pizzaIndex+1}`;
      const pizzaLink = document.querySelector(`.pizza-edit-link[data-pizza='${pizzaIndex+1}']`);
      pizzaLink.textContent = newName;
      pizzaLink.setAttribute('data-pizza-name', newName);
      pizzaNames[pizzaIndex] = newName;
      updatePizzaCosts();
      document.getElementById('pizza-edit-modal').style.display = 'none';
      
              // Update modal menu cards
        updateModalPizzaMenuCards();
    };

    // Add Daily Report Modal Functions
    // Add variable to track last daily report
    let lastDailyReport = null;

    // Modify showDailyReport to store the report data
    function showDailyReport(dayResult) {
      // Store the report data for later use
      lastDailyReport = dayResult;
      
      const modal = document.getElementById('daily-report-modal');
      modal.style.display = 'flex';
      
      // Enable the daily report button
      document.getElementById('daily-report-button').disabled = false;
      
      // Update the day number in the title
      document.getElementById('daily-report-day').textContent = dayResult.day;
      
      // Always reset to Sales tab by default
      switchDailyReportTab('sales');
      
      // Calculate and display total profit
      const ingredientCosts = getIngredientCosts();
      const totalProfit = dayResult.customers.reduce((sum, customer) => {
        const pizza = getPizzaData()[customer.pizzaIndex];
        // Calculate cost of ingredients for this pizza
        const pizzaCost = INGREDIENTS.reduce((cost, ing) => {
          return cost + (pizza.recipe[ing] * ingredientCosts[ing]);
        }, 0);
        return sum + (pizza.price - pizzaCost);
      }, 0);
      document.getElementById('daily-total-profit').textContent = totalProfit;
      
      // Add marketing activity and remaining cash information to Sales tab
      const salesTab = document.getElementById('sales-tab');
      const pizzaSalesGrid = salesTab.querySelector('#pizza-sales-grid');
      
      // Remove any existing marketing activity elements
      const existingMarketingElements = salesTab.querySelectorAll('.feedback');
      existingMarketingElements.forEach(el => {
        if (el.textContent.includes('Marketing Activity') || el.textContent.includes('Remaining Cash')) {
          el.remove();
        }
      });
      
      // Create marketing activity element
      let marketingHTML = '';
      if (dayResult.marketing) {
        marketingHTML = `<div class="feedback" style="margin-bottom: 15px;">
          <b>Marketing Activity:</b> ${dayResult.marketing.type.charAt(0).toUpperCase() + dayResult.marketing.type.slice(1)} 
          targeting ${dayResult.marketing.target} (Cost: $${dayResult.marketing.cost})<br>
          <b>Remaining Cash:</b> $${playerCash} USD
        </div>`;
      } else {
        marketingHTML = `<div class="feedback" style="margin-bottom: 15px;">
          <b>Remaining Cash:</b> $${playerCash} USD
        </div>`;
      }
      
      // Insert marketing activity after sales summary and before pizza sales grid
      const salesSummary = salesTab.querySelector('.sales-summary');
      salesSummary.insertAdjacentHTML('afterend', marketingHTML);
      
      // Update Sales Tab
      const salesGrid = document.getElementById('pizza-sales-grid');
      salesGrid.innerHTML = '';
      
      // Count pizza sales and calculate profits
      const pizzaStats = {};
      dayResult.customers.forEach(customer => {
        const pizza = getPizzaData()[customer.pizzaIndex];
        if (!pizzaStats[pizza.name]) {
          pizzaStats[pizza.name] = {
            count: 0,
            profit: 0,
            recipe: pizza.recipe
          };
        }
        pizzaStats[pizza.name].count++;
        // Calculate profit for this pizza
        const pizzaCost = INGREDIENTS.reduce((cost, ing) => {
          return cost + (pizza.recipe[ing] * ingredientCosts[ing]);
        }, 0);
        pizzaStats[pizza.name].profit += (pizza.price - pizzaCost);
      });
      
      // Create pizza sales cards
      Object.entries(pizzaStats).forEach(([name, data]) => {
        const card = document.createElement('div');
        card.className = 'pizza-sales-card';
        card.innerHTML = `
          <div class="pizza-name">${name}</div>
          <div class="pizza-visual">
            <div class="pizza-crust"></div>
            <div class="pizza-sauce"></div>
            <div class="pizza-cheese"></div>
            <div class="pizza-toppings"></div>
          </div>
          <div class="pizza-sales-stats">
            <div class="pizza-sales-stat">
              <span>Customers:</span>
              <span>${data.count}</span>
            </div>
            <div class="pizza-sales-stat">
              <span>Total Profit:</span>
              <span>$${data.profit} USD</span>
            </div>
            <div class="pizza-sales-stat">
              <span>Profit per Pizza:</span>
              <span>$${(data.profit / data.count).toFixed(2)} USD</span>
            </div>
          </div>
        `;
        salesGrid.appendChild(card);
        
        // Update pizza visual
        const toppingsContainer = card.querySelector('.pizza-toppings');
        updatePizzaVisualForMenu(data.recipe, toppingsContainer);
      });
      
      // Update Satisfaction Tab
      const satisfactionGrid = document.getElementById('satisfaction-grid');
      satisfactionGrid.innerHTML = '';
      
      // Group customers by segment to find most popular pizza and last feedback
      const segmentData = {};
      CUSTOMER_SEGMENTS.forEach(seg => {
        segmentData[seg.name] = {
          customers: [],
          pizzaCounts: {},
          lastFeedback: null
        };
      });
      
      // Process all customers to gather segment data
      dayResult.customers.forEach(customer => {
        const segment = customer.segment;
        segmentData[segment].customers.push(customer);
        const pizzaName = getPizzaData()[customer.pizzaIndex].name;
        segmentData[segment].pizzaCounts[pizzaName] = (segmentData[segment].pizzaCounts[pizzaName] || 0) + 1;
        segmentData[segment].lastFeedback = customer.feedback; // Keep updating with last customer's feedback
      });
      
      CUSTOMER_SEGMENTS.forEach(seg => {
        const avgSatisfaction = dayResult.segmentCounts[seg.name] > 0 ? 
          (dayResult.segmentSatisfaction[seg.name] / dayResult.segmentCounts[seg.name]) : 0;
        const coverage = (dayResult.segmentTotalServed[seg.name] / seg.totalCustomers) * 100;
        const weightedScore = avgSatisfaction * (coverage / 100);
        
        // Find most popular pizza for this segment
        const pizzaCounts = segmentData[seg.name].pizzaCounts;
        const mostPopularPizza = Object.entries(pizzaCounts)
          .sort((a, b) => b[1] - a[1])[0]?.[0] || 'None';
        
        const card = document.createElement('div');
        card.className = 'segment-satisfaction-card';
        card.innerHTML = `
          <div class="segment-avatar">
            <img src="${SEGMENT_AVATARS[seg.name]}" alt="${seg.name}">
          </div>
          <div class="segment-name">${seg.name}</div>
          <div class="satisfaction-score">${weightedScore.toFixed(2)}</div>
          <div class="satisfaction-label">Satisfaction Score</div>
          <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 8px; width: 100%;">
            <div style="margin-bottom: 8px;">
              <span style="font-weight: bold; color: #b33c00;">Pizza of Choice:</span><br>
              ${mostPopularPizza}
            </div>
            <div>
              <span style="font-weight: bold; color: #b33c00;">Last Feedback:</span><br>
              <span style="font-style: italic;">"${segmentData[seg.name].lastFeedback || 'No feedback'}"</span>
            </div>
          </div>
        `;
        satisfactionGrid.appendChild(card);
      });
    }
    
    function showLastDailyReport() {
      if (lastDailyReport) {
        showDailyReport(lastDailyReport);
      }
    }
    
    function closeDailyReport() {
      document.getElementById('daily-report-modal').style.display = 'none';
    }
    
    function switchDailyReportTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.daily-report-tab').forEach(t => {
        t.classList.toggle('active', t.textContent.toLowerCase() === tab);
      });
      
      // Update tab content
      document.querySelectorAll('.daily-report-tab-content').forEach(c => {
        c.classList.toggle('active', c.id === `${tab}-tab`);
      });
    }
  </script>
</body>
</html> 